name: Hygiene Checks

on:
  push:
    branches: [main]

jobs:
  static-analysis:
    name: Static Code Analysis
    runs-on: windows-latest
    env:
          JACOCO_MIN_COVERAGE: 80

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # Setup Java
      - name: â˜• Set up JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '24'

      - name: List directory structure for debug
        run: dir /s /b
        shell: cmd

      ##########################
      # DOWNLOAD: Checkstyle
      ##########################
      - name: ðŸ“¦ Download Checkstyle
        run: |
          mkdir tools\checkstyle
          curl -L -o tools\checkstyle\checkstyle-10.26.1-all.jar https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.26.1/checkstyle-10.26.1-all.jar
      # move checkstyle.jar tools\checkstyle\checkstyle.jar

      ##########################
      # DOWNLOAD: PMD
      ##########################
      - name: ðŸ“¦ Download and Extract PMD
        run: curl -L -o pmd.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.15.0/pmd-dist-7.15.0-bin.zip
        shell: bash

      ##########################
      # EXTRACT: PMD ZIP
      ##########################
      - name: ðŸ“¦ Extract PMD ZIP
        run: |
          mkdir -p tools/pmd
          powershell -Command "Expand-Archive -Path 'pmd.zip' -DestinationPath 'tools/pmd'"
        shell: cmd

      ##########################
      # VERIFY DIRECTORY: PMD
      ##########################
      - name: ðŸ“¦ Verify PMD Directory
        run: dir /s /b tools\pmd
        shell: cmd

      ##########################
      # RUN: Checkstyle Analysis
      ##########################
      - name: ðŸ§¼ Run Checkstyle
        run: scripts\run-checkstyle.bat


      ##########################
      # RUN: Checkstyle Analysis
      ##########################
      - name: ðŸ§¼ Run PMD Analysis
        run: scripts\run-pmd.bat
        shell: cmd

      ##########################
      # UPLOAD: Reports as Artifacts
      ##########################
      - name: â¬†ï¸ Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: static-analysis-reports
          path: |
            reports\checkstyle\*.*
            reports\pmd\*.*
            logs\checkstyle-logs\*.*
            logs\pmd-analysis-logs\*.*

      - name: ðŸ” List Generated Reports
        run: dir reports /s
        shell: cmd

      - name: ðŸ“Š Post Violation Summary
        shell: bash
        run: |
          echo "### ðŸ”Ž Static Analysis Violation Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Tool        | Violations |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|------------|" >> $GITHUB_STEP_SUMMARY

          CHECKSTYLE_COUNT=0
          PMD_COUNT=0

          if compgen -G "reports/checkstyle/*.txt" > /dev/null; then
            CHECKSTYLE_COUNT=$(grep -E "^[^[:space:]]" reports/checkstyle/*.txt | wc -l || echo 0)
          fi

          if compgen -G "reports/pmd/*.txt" > /dev/null; then
            PMD_COUNT=$(grep -E "^[A-Za-z]:" reports/pmd/*.txt | wc -l || echo 0)
          fi

          TOTAL=$((CHECKSTYLE_COUNT + PMD_COUNT))

          echo "| Checkstyle  | $CHECKSTYLE_COUNT       |" >> $GITHUB_STEP_SUMMARY
          echo "| PMD         | $PMD_COUNT       |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|------------|" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Violations:** \`$TOTAL\`" >> $GITHUB_STEP_SUMMARY

          if [ "$TOTAL" -le 50 ]; then
            echo "**âœ… Clean! Great job keeping code quality high.**" >> $GITHUB_STEP_SUMMARY
          elif [ "$TOTAL" -le 100 ]; then
            echo "**âš ï¸ Moderate issues found â€” consider refactoring.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "**âŒ High number of violations â€” review and clean up.**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¦ Download JaCoCo + JUnit Console
        run: |
          mkdir tools\jacoco-0.8.13\lib
          curl -L -o tools\jacoco-0.8.13\lib\jacocoagent.jar https://repo1.maven.org/maven2/org/jacoco/org.jacoco.agent/0.8.13/org.jacoco.agent-0.8.13-runtime.jar
          curl -L -o tools\jacoco-0.8.13\lib\jacococli.jar https://repo1.maven.org/maven2/org/jacoco/org.jacoco.cli/0.8.13/org.jacoco.cli-0.8.13-nodeps.jar
          mkdir tools\junit-console
          curl -L -o tools\junit-console\junit-platform-console-standalone-1.13.0.jar https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.13.0/junit-platform-console-standalone-1.13.0.jar
        shell: cmd

      - name: ðŸ› ï¸ Compile Java Modules if Needed
        shell: cmd
        run: |
          set "JAVA_HOME=%JAVA_HOME%"
          set "OUT_PROD=out\production"
          set "OUT_TEST=out\test"
          set "SRC_MAIN=src\main\java"
          set "SRC_MISC=misc_utils\src\main\java"
          set "TEST_MAIN=src\test\java"
          set "TEST_MISC=misc_utils\src\test\java"
          set "JUNIT_JAR=tools\junit-console\junit-platform-console-standalone-1.13.0.jar"

          if not exist "%OUT_PROD%\udemy_lpa_javamasterclass" (
            if not exist "%OUT_PROD%\misc_utils" (
              echo âš™ Compilation triggered

              rmdir /s /q "%OUT_PROD%" >nul 2>&1
              rmdir /s /q "%OUT_TEST%" >nul 2>&1

              mkdir "%OUT_PROD%\udemy_lpa_javamasterclass"
              mkdir "%OUT_PROD%\misc_utils"
              mkdir "%OUT_TEST%\udemy_lpa_javamasterclass"
              mkdir "%OUT_TEST%\misc_utils"

              echo âœ Compiling udemy_lpa_javamasterclass
              dir /s /b "%SRC_MAIN%\*.java" > sources_main.txt
              javac --enable-preview --release 24 -encoding UTF-8 -d "%OUT_PROD%\udemy_lpa_javamasterclass" @sources_main.txt

              echo âœ Compiling misc_utils
              dir /s /b "%SRC_MISC%\*.java" > sources_misc.txt
              javac --enable-preview --release 24 -encoding UTF-8 -cp "%OUT_PROD%\udemy_lpa_javamasterclass" -d "%OUT_PROD%\misc_utils" @sources_misc.txt

              echo âœ Compiling tests (masterclass)
              dir /s /b "%TEST_MAIN%\*.java" > sources_test_main.txt
              javac --enable-preview --release 24 -encoding UTF-8 -cp "%OUT_PROD%\udemy_lpa_javamasterclass;%OUT_PROD%\misc_utils;%JUNIT_JAR%" -d "%OUT_TEST%\udemy_lpa_javamasterclass" @sources_test_main.txt

              echo âœ Compiling tests (misc_utils)
              if exist "%TEST_MISC%" (
                dir /s /b "%TEST_MISC%\*.java" > sources_test_misc.txt
                javac --enable-preview --release 24 -encoding UTF-8 -cp "%OUT_PROD%\udemy_lpa_javamasterclass;%OUT_PROD%\misc_utils;%JUNIT_JAR%" -d "%OUT_TEST%\misc_utils" @sources_test_misc.txt
              )

              del sources_main.txt sources_misc.txt sources_test_main.txt sources_test_misc.txt
            )
          )

      - name: ðŸ§ª Run JaCoCo Coverage Analysis
        run: scripts\run-coverage-analysis.bat
        shell: cmd

      - name: ðŸ“¤ Upload JaCoCo Reports
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-reports
          path: |
            reports/jacoco
            logs/jacoco-logs

      - name: ðŸ“Š Add Coverage Summary to UI
        shell: pwsh
        run: |
          $xml = Select-Xml -Path reports\jacoco\jacoco-latest.xml -XPath "//report/counter[@type='INSTRUCTION']"
          $missed = [int]$xml.Node.missed
          $covered = [int]$xml.Node.covered
          $total = $missed + $covered
          if ($total -gt 0) {
            $percent = [math]::Round(100 * $covered / $total, 2)
          } else {
            $percent = 0
          }

          echo "### ðŸ§ª JaCoCo Coverage Summary" >> $env:GITHUB_STEP_SUMMARY
          echo "| Metric    | Value     |" >> $env:GITHUB_STEP_SUMMARY
          echo "|-----------|-----------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| Covered   | $covered   |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Missed    | $missed    |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Total     | $total     |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Coverage  | $percent%  |" >> $env:GITHUB_STEP_SUMMARY

          if ($percent -lt $env:JACOCO_MIN_COVERAGE) {
            echo "âš ï¸ Warning: Coverage $percent% is below threshold $env:JACOCO_MIN_COVERAGE%" >> $env:GITHUB_STEP_SUMMARY
          }

      - name: ðŸ“Š Post Summary to UI
              shell: pwsh
              run: |
                echo "### ðŸ§¼ Hygiene Summary" >> $env:GITHUB_STEP_SUMMARY

                # Checkstyle + PMD
                echo "#### ðŸ”Ž Static Analysis" >> $env:GITHUB_STEP_SUMMARY
                echo "| Tool        | Violations |" >> $env:GITHUB_STEP_SUMMARY
                echo "|-------------|------------|" >> $env:GITHUB_STEP_SUMMARY

                $checkstyleCount = 0
                if (Test-Path "reports\checkstyle") {
                  $checkstyleCount = (Get-Content reports\checkstyle\*.txt -ErrorAction SilentlyContinue | Where-Object { $_ -match '^\S' }).Count
                }

                $pmdCount = 0
                if (Test-Path "reports\pmd") {
                  $pmdCount = (Get-Content reports\pmd\*.txt -ErrorAction SilentlyContinue | Where-Object { $_ -match '^[A-Za-z]:' }).Count
                }

                $totalStatic = $checkstyleCount + $pmdCount
                echo "| Checkstyle  | $checkstyleCount |" >> $env:GITHUB_STEP_SUMMARY
                echo "| PMD         | $pmdCount        |" >> $env:GITHUB_STEP_SUMMARY
                echo "**Total Violations:** \`$totalStatic\`" >> $env:GITHUB_STEP_SUMMARY

                # JaCoCo
                echo "" >> $env:GITHUB_STEP_SUMMARY
                echo "#### ðŸ§ª JaCoCo Coverage Summary" >> $env:GITHUB_STEP_SUMMARY
                $xml = Select-Xml -Path reports\jacoco\jacoco-latest.xml -XPath "//report/counter[@type='INSTRUCTION']"
                $missed = [int]$xml.Node.missed
                $covered = [int]$xml.Node.covered
                $total = $missed + $covered
                if ($total -gt 0) {
                  $percent = [math]::Round(100 * $covered / $total, 2)
                } else {
                  $percent = 0
                }
                echo "| Metric    | Value     |" >> $env:GITHUB_STEP_SUMMARY
                echo "|-----------|-----------|" >> $env:GITHUB_STEP_SUMMARY
                echo "| Covered   | $covered   |" >> $env:GITHUB_STEP_SUMMARY
                echo "| Missed    | $missed    |" >> $env:GITHUB_STEP_SUMMARY
                echo "| Total     | $total     |" >> $env:GITHUB_STEP_SUMMARY
                echo "| Coverage  | $percent%  |" >> $env:GITHUB_STEP_SUMMARY
                if ($percent -lt $env:JACOCO_MIN_COVERAGE) {
                  echo "âš ï¸ Warning: Coverage $percent% is below threshold $env:JACOCO_MIN_COVERAGE%" >> $env:GITHUB_STEP_SUMMARY
                }

            - name: ðŸ§¹ Cleanup
              shell: cmd
              run: |
                del pmd.zip >nul 2>&1
                echo Cleanup complete