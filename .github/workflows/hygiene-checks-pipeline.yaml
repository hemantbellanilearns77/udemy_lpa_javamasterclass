name: üìä Hygiene Checks Pipeline
on:
  # workflow_dispatch: # run manually
  schedule:
    # - cron: '45 06 * * 1-4' # Runs 12:15 PM IST  every WeekDay excluding Friday
    - cron: '38 7 * * *' # Runs 1:08 PM IST  every Day
  push:
    branches:
    - main
jobs:
  hygiene-checks:
    name: Hygiene Checks - Checkstyle + PMD + JaCoCo + Sonar
    runs-on: windows-latest
    env:
      MODULE_PATHS: |
        udemy_lpa_javamasterclass_main=src/main/java/com/hb/study/udemy_lpa_javamasterclass
        misc_utils_main=misc_utils/src/main/java/com/hb/study/misc_utils
        udemy_lpa_javamasterclass_test=src/test/java/com/hb/study/udemy_lpa_javamasterclass
        misc_utils_test=misc_utils/src/test/java/com/hb/study/misc_utils
      TRIGGER_TYPE: ${{ github.event_name }}
      TRIGGER_BRANCH: ${{ github.ref_name }}
      JACOCO_MIN_COVERAGE: 9
      CHECKSTYLE_PMD_MAX_TOTAL_VIOLATIONS: 12006
      CHECKSTYLE_MAX_VIOLATIONS: 12000
      PMD_MAX_VIOLATIONS: 63
      SONAR_ORG: ${{ vars.SONAR_ORG }}
      SONAR_PROJECT_KEY: ${{ vars.SONAR_PROJECT_KEY }}
      SKIP_ECHO: true
      SONAR_FETCH_SLEEP_TIME: 27

    steps:

      ####################################################
                # CHECKOUT CODE COMMITTED
      ####################################################
      - name: ?? Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # fetches all history, not just 1 commit

      ####################################################
      # CAPTURE START TIME OF GITHUB ACTION's JOB
      ####################################################
      - name: Call Start Time Action
        id: start_time
        uses: ./.github/actions/setup-starttime

      ####################################################
            # EXTRACT COMMIT STATS and TRIGGER INFO
      ####################################################

      - name: ?? Extract Commit Info (Windows PowerShell)
        id: execution_info
        uses: ./.github/actions/extract-commit-stats
        
#      - name: Use output in summary
#        run: |
#          echo "FULL_SHA is : ${{ steps.execution_info.outputs.FULL_SHA }}"
        
      ##############################################################################
        # Setup JDK 24 (Temurin with Zulu fallback for JaCoCo + Compilation)
      ##############################################################################
      - name: Setup Java (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 24
        continue-on-error: true

      - name: Fallback Setup Java (Zulu)
        if: failure()
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 24
      
      #######################################################################
        # DOWNLOAD TOOLS (CHECKSTYLE AND PMD AND JACOCO AND SONAR) AND SETUP
      #######################################################################
      - name: Download Tools & Setup for Execution
        id: download_setup_tools
        uses: ./.github/actions/download-setup-tools

      ##########################
      # COMPILE + JACOCO
      ##########################

      - name: ??? Compile Java Modules if Needed
        shell: cmd
        run: |
          set "JAVA_HOME=%JAVA_HOME%"
          set "OUT_PROD=out\production"
          set "OUT_TEST=out\test"
          set "SRC_MAIN=src\main\java"
          set "SRC_MISC=misc_utils\src\main\java"
          set "TEST_MAIN=src\test\java"
          set "TEST_MISC=misc_utils\src\test\java"
          set "JUNIT_JAR=tools\junit-console\junit-platform-console-standalone-1.13.0.jar"

          if not exist "%OUT_PROD%\udemy_lpa_javamasterclass" (
            if not exist "%OUT_PROD%\misc_utils" (
              echo ? Compilation triggered

              rmdir /s /q "%OUT_PROD%" >nul 2>&1
              rmdir /s /q "%OUT_TEST%" >nul 2>&1

              mkdir "%OUT_PROD%\udemy_lpa_javamasterclass"
              mkdir "%OUT_PROD%\misc_utils"
              mkdir "%OUT_TEST%\udemy_lpa_javamasterclass"
              mkdir "%OUT_TEST%\misc_utils"

              echo ? Compiling udemy_lpa_javamasterclass
              dir /s /b "%SRC_MAIN%\*.java" > sources_main.txt
              javac --enable-preview --release 24 -encoding UTF-8 -d "%OUT_PROD%\udemy_lpa_javamasterclass" @sources_main.txt

              echo ? Compiling misc_utils
              dir /s /b "%SRC_MISC%\*.java" > sources_misc.txt
              javac --enable-preview --release 24 -encoding UTF-8 -cp "%OUT_PROD%\udemy_lpa_javamasterclass" -d "%OUT_PROD%\misc_utils" @sources_misc.txt

              echo ? Compiling tests (masterclass)
              dir /s /b "%TEST_MAIN%\*.java" > sources_test_main.txt
              javac --enable-preview --release 24 -encoding UTF-8 -cp "%OUT_PROD%\udemy_lpa_javamasterclass;%OUT_PROD%\misc_utils;%JUNIT_JAR%" -d "%OUT_TEST%\udemy_lpa_javamasterclass" @sources_test_main.txt

              echo ? Compiling tests (misc_utils)
              if exist "%TEST_MISC%" (
                dir /s /b "%TEST_MISC%\*.java" > sources_test_misc.txt
                javac --enable-preview --release 24 -encoding UTF-8 -cp "%OUT_PROD%\udemy_lpa_javamasterclass;%OUT_PROD%\misc_utils;%JUNIT_JAR%" -d "%OUT_TEST%\misc_utils" @sources_test_misc.txt
              )

              del sources_main.txt sources_misc.txt sources_test_main.txt sources_test_misc.txt
            )
          )

      #####################################
        # RUN ALL-HYGIENE SWEEP CHECK
      #####################################
      - name: ALL-HYGIENE SWEEP CHECK ( Run hygiene health check analysis using via batch script )
        if: success()
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: scripts\hygiene-check-analysis.bat githubactions
        shell: cmd

      ##########################
      # UPLOAD REPORTS
      ##########################

      - name: ?? Upload All Reports
        uses: actions/upload-artifact@v4
        with:
          name: hygiene-reports
          path: |
            reports/**
            logs/**

      ##########################
      # SUMMARY SECTION
      ##########################

      - name: üìä Add Hygiene Summary (Checkstyle + PMD + JaCoCo + Sonar Issues)
        id: metrics
        shell: pwsh
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          ############################################################
          # === Parse JaCoCo XML (Overall) ===
          ############################################################
          $xml = Select-Xml -Path reports\jacoco\jacoco-latest.xml -XPath "//report/counter[@type='INSTRUCTION']"
          $missed = [int]$xml.Node.missed
          $covered = [int]$xml.Node.covered
          $total = $missed + $covered
          if ($total -gt 0) {
            $jacocoCoverage = [math]::Round(100 * $covered / $total, 2)
          } else {
            $jacocoCoverage = 0
          }

          function Get-AsciiBar($percent) {
          
            $blocks = 50
            $filled = [math]::Round($blocks * $percent / 100)
            $empty = $blocks - $filled
            return ('‚ñà' * $filled) + ('‚ñë' * $empty)
          }
          
          ############################################################
          # === Parse Checkstyle & PMD Reports ===
          ############################################################
          $checkstyleViolations = 0
          if (Test-Path "reports/checkstyle") {
            Get-ChildItem reports/checkstyle/*.txt | ForEach-Object {
              $checkstyleViolations += (Get-Content $_ | Where-Object { $_.Trim() -ne "" }).Count
            }
          }

          $pmdViolations = 0
          if (Test-Path "reports/pmd") {
            Get-ChildItem reports/pmd/*.txt | ForEach-Object {
              $pmdViolations += (Get-Content $_ | Where-Object { $_ -match "^[A-Za-z]:\\" }).Count
            }
          }
          $totalViolations = $checkstyleViolations + $pmdViolations

          ############################################################
          # === Fetch SonarCloud Issue Count (OPEN) ===
          ############################################################
          Start-Sleep -Seconds $env:SONAR_FETCH_SLEEP_TIME
          
          $projectKey = $env:SONAR_PROJECT_KEY
          $projectOrg = $env:SONAR_ORG
          $branch = $env:TRIGGER_BRANCH 
          # Confirm if token is passed
          if (-not $env:SONAR_TOKEN) {
           Write-Error "‚ö† SONAR_TOKEN is empty!"
           exit 1
          }
          $url = "https://sonarcloud.io/api/issues/search?issueStatuses=OPEN,CONFIRMED&id=$projectKey&organization=$projectOrg"
          Write-Host "?? Calling SonarCloud API: $url"
          try {
           $response = Invoke-WebRequest -Uri $url -Method Get
           $body = $response.Content
          
           if ($body -match '"total"\s*:\s*(\d+)') {
             $totalSonarFetchedIssues = $matches[1]
             Write-Host "? Total SonarCloud Issues (OPEN): $totalSonarFetchedIssues"
           } else {
             Write-Error "? Could not extract issue count from response body: $body"
             exit 1
           }
          } catch {
           Write-Error "‚ö† API call failed: $_"
           exit 1
          }


          ############################################################
          # === Fetch SonarCloud Coverage Metrics ===
          ############################################################
          $encodedAuth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("${{ secrets.SONAR_TOKEN }}:"))
          $headers = @{ Authorization = "Basic $encodedAuth" }

          function Get-SonarMetric($metricKey) {
            $url = "https://sonarcloud.io/api/measures/component?component=$projectKey&metricKeys=coverage"
            Write-Host "Coverage Fetch URL is $url"
            try {
              $resp = Invoke-WebRequest -Uri $url -Method Get
              $json = $resp.Content | ConvertFrom-Json
              return $json.component.measures[0].value
            } catch {
              Write-Error "‚ö† API call failed: $_"
              exit 1
            }
          }

          $sonarCoverage = Get-SonarMetric "coverage"
          Write-Output "Writing Output Coverage as fetched from Sonar is $sonarCoverage" 
          if ($sonarCoverage -ge 50) {
            $coverageEmoji = "üü¢"
          } elseif ($sonarCoverage -ge 20) {
            $coverageEmoji = "üü°"
          } else {
            $coverageEmoji = "üî¥"
          }
          $coverageBar = Get-AsciiBar $sonarCoverage
          
          $sonarCoverage = Get-SonarMetric "coverage"
          # Ensure only the first numeric value is used
          if ($sonarCoverage -is [array]) {
            $sonarCoverage = $sonarCoverage[0]
          }
          # Try to cast to a number safely
          $sonarCoverage = [double]($sonarCoverage -replace '[^0-9\.]', '')
          if ($sonarCoverage -ge 50) {
            $coverageEmoji = "üü¢"
          } elseif ($sonarCoverage -ge 20) {
            $coverageEmoji = "üü°"
          } else {
            $coverageEmoji = "üî¥"
          }
          $coverageBar = Get-AsciiBar $sonarCoverage

          ###########################################################
          # === Fetch Overall Severity Breakdown (UI-Aligned) ===
          ###########################################################
           function Fetch-SonarSeverity($severity) {
            $url = "https://sonarcloud.io/api/issues/search?severities=$severity&issueStatuses=OPEN,CONFIRMED&organization=$projectOrg&id=$projectKey"
          
            try {
              $resp = Invoke-WebRequest -Uri $url -Headers $headers -Method Get
              $json = $resp.Content | ConvertFrom-Json
              return $json.total
            } catch {
              Write-Error "‚ö† API call failed: $_"
              exit 1
            }
          }

          $blocker = Fetch-SonarSeverity "BLOCKER"
          $high = Fetch-SonarSeverity "CRITICAL"
          $medium = Fetch-SonarSeverity "MAJOR"
          $low = Fetch-SonarSeverity "MINOR"
          $info = Fetch-SonarSeverity "INFO"
          ############################################################
          # === Generate Severity URLs (global and per module) ===
          ############################################################
          $severityLinks = @{
            BLOCKER = "https://sonarcloud.io/project/issues?severities=BLOCKER&issueStatuses=OPEN,CONFIRMED&id=$projectKey"
            HIGH    = "https://sonarcloud.io/project/issues?severities=CRITICAL&issueStatuses=OPEN,CONFIRMED&id=$projectKey"
            MEDIUM  = "https://sonarcloud.io/project/issues?severities=MAJOR&issueStatuses=OPEN,CONFIRMED&id=$projectKey"
            LOW     = "https://sonarcloud.io/project/issues?severities=MINOR&issueStatuses=OPEN,CONFIRMED&id=$projectKey"
            INFO    = "https://sonarcloud.io/project/issues?severities=INFO&issueStatuses=OPEN,CONFIRMED&id=$projectKey"
          }
          
          
          ############################################################
                # === Generate URLS ===
          ############################################################
           $sonarOverallCodeDashBoardUrl = "https://sonarcloud.io/summary/overall?id=$projectKey&branch=$branch"
           $sonarOpenIssuesDashboardUrl= "https://sonarcloud.io/project/issues?issueStatuses=OPEN%2CCONFIRMED&id=$projectKey"
          
           function MarkEmoji($count) {
              if ($count -eq 0) { return "‚úÖ" }
              elseif ($count -le 5) { return "üü°" }
              else { return "üî¥" }
            } # end of function Mark
          
          $sonarBlockerEmojiMark = $(MarkEmoji $blocker)
          $sonarHighEmojiMark = $(MarkEmoji $high)
          $sonarMediumEmojiMark = $(MarkEmoji $medium)
          $sonarLowEmojiMark = $(MarkEmoji $low)
          $sonarInfoEmojiMark = $(MarkEmoji $info)
          
          
          ############################################################
                # === Write Overall Table ===
          ############################################################
          echo "### üìä Hygiene Summary (Checkstyle + PMD + JaCoCo + Sonar)" >> $env:GITHUB_STEP_SUMMARY
          echo "| **Metric**              | **Value** |" >> $env:GITHUB_STEP_SUMMARY
          echo "|-------------------------|-----------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| Checkstyle Violations   | $checkstyleViolations |" >> $env:GITHUB_STEP_SUMMARY
          echo "| PMD Violations          | $pmdViolations |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Code Coverage (Sonar)   | $sonarCoverage% $coverageEmoji |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Coverage Visual         | <code>$coverageBar</code> |" >> $env:GITHUB_STEP_SUMMARY
          echo "|-------------------------|-----------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| üóÇ Sonar Issues (Total) | $totalSonarFetchedIssues |" >> $env:GITHUB_STEP_SUMMARY
          echo "| üü• BLOCKER              | $sonarBlockerEmojiMark [$blocker]($($severityLinks.BLOCKER)) |" >> $env:GITHUB_STEP_SUMMARY
          echo "| üüß HIGH                 | $sonarHighEmojiMark [$high]($($severityLinks.HIGH)) |" >> $env:GITHUB_STEP_SUMMARY
          echo "| üü® MEDIUM               | $sonarMediumEmojiMark [$medium]($($severityLinks.MEDIUM)) |" >> $env:GITHUB_STEP_SUMMARY
          echo "| üü¶ LOW                  | $sonarLowEmojiMark [$low]($($severityLinks.LOW)) |" >> $env:GITHUB_STEP_SUMMARY
          echo "| ‚Ñπ INFO                 | $sonarInfoEmojiMark [$info]($($severityLinks.INFO)) |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Legend                 | ‚úÖ is GREAT-GOING üü° is WATCH-OUT  üî¥ is GONE-OVERBOARD |" >> $env:GITHUB_STEP_SUMMARY
          echo "|-------------------------|-----------|" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "üåê [View SonarCloud Overall Code Dashboard]($sonarOverallCodeDashBoardUrl)" >> $env:GITHUB_STEP_SUMMARY
          echo "üåê [View SonarCloud Issues Breakdown Dashboard]($sonarOpenIssuesDashboardUrl)" >> $env:GITHUB_STEP_SUMMARY
          
          
          ############################################################
          # === Outputs for Email ===
          ############################################################
          "checkstyleCount=$checkstyleViolations" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "pmdCount=$pmdViolations" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "totalSonarFetchedIssues=$totalSonarFetchedIssues" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "coverageBar=$coverageBar" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "sonarCoverage=$sonarCoverage%" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          
          "sonarBlocker=$blocker" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "sonarBlockerEmojiMark=$sonarBlockerEmojiMark" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "sonarBlockerURL=$($severityLinks.BLOCKER)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          
          "sonarHigh=$high" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "sonarHighEmojiMark=$sonarHighEmojiMark" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "sonarHighURL=$($severityLinks.HIGH)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          
          "sonarMedium=$medium" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "sonarMediumEmojiMark=$sonarMediumEmojiMark" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "sonarMediumURL=$($severityLinks.MEDIUM)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          
          "sonarLow=$low" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "sonarLowEmojiMark=$sonarLowEmojiMark" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "sonarLowURL=$($severityLinks.LOW)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          
          "sonarInfo=$info" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "sonarInfoEmojiMark=$sonarInfoEmojiMark" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "sonarInfoURL=$($severityLinks.INFO)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          
          "sonarOverallCodeDashBoardURL=$sonarOverallCodeDashBoardUrl" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "sonarOpenIssuesDashboardURL=$sonarOpenIssuesDashboardUrl" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          
          ###############################################################################
          # === SonarCloud Module Severity Breakdown (Aggregated per MODULE_PATHS) ===
          ###############################################################################
          
          # Normalize line endings, build map
          $modulePathMap = @{}
          $lines = ($env:MODULE_PATHS -replace "`r", "") -split "`n"
          
          foreach ($line in $lines) {
            if ($line.Trim()) {
            $parts = $line.Trim() -split "=", 2  # limit to 2 parts only 
            Write-Output "Next line: '$line' split into key='$($parts[1])' and value='$($parts[0])'"
              if ($parts.Count -eq 2) {
                Write-Output "Creating map entry: key='$($parts[1])', value='$($parts[0])'"
                $modulePathMap[$parts[1]] = $parts[0]
              }
            }
          }
          
          # Debug: print map
            foreach ($k in $modulePathMap.Keys) {
              Write-Output "Map Key: $k => Value: $($modulePathMap[$k])"
          }
          # Initialize aggregation buckets for each module
          $moduleAgg = @{}
          foreach ($pathKey in $modulePathMap.Keys) {
            Write-Output "Iterating over modulePathMap next path key is $pathKey"
            $moduleName = $modulePathMap[$pathKey]
            Write-Output "So moduleName is initialized to: $moduleName"
            if (-not $moduleAgg) {
                  Write-Output "‚ùå moduleAgg is NULL"
            } 
          
            if (-not $moduleAgg.ContainsKey($moduleName)) { 
          
              $moduleAgg[$moduleName] = @{
              BLOCKER = 0; HIGH = 0; MEDIUM = 0; LOW = 0; INFO = 0
              }
            }
          }
          if (-not $moduleAgg) {
                  Write-Output "‚ùå moduleAgg is NULL"
          }  else {
                  Write-Output "‚úÖ moduleAgg exists. Current contents:"
                  $moduleAgg.GetEnumerator() | ForEach-Object {
                  $val = $_.Value
                  if (-not $val) {
                    Write-Output ("   ‚ö† Key = {0}, Value is NULL" -f $_.Key)
                  }
                  else {
                    Write-Output ("   Key = {0}, Value = {1}" -f $_.Key, ($val | ConvertTo-Json -Compress))
                  }
                } 
             # Debug: Print out current aggregate state
             Write-Output "----- Current Module Aggregates -----"
             foreach ($moduleName in $moduleAgg.Keys) {
              $bucket = $moduleAgg[$moduleName]
              Write-Output ("Module: {0} | BLOCKER={1}, HIGH={2}, MEDIUM={3}, LOW={4}, INFO={5}" -f `
                                   $moduleName, $bucket.BLOCKER, $bucket.HIGH, $bucket.MEDIUM, $bucket.LOW, $bucket.INFO)
             }
              Write-Output "--------------------------------------"
            }
          
          # Step 1: Get directory list from SonarCloud
          $dirFacetssUrl = "https://sonarcloud.io/api/issues/search?organization=$projectOrg&componentKeys=$projectKey&resolved=false&facets=directories&ps=1"
          Write-Output "Fetching directories from: $dirFacetssUrl"
          $resp = Invoke-WebRequest -Uri $dirFacetssUrl -Headers $headers -Method Get
          $json = $resp.Content | ConvertFrom-Json
          $directories = $json.facets | Where-Object { $_.property -eq "directories" } | Select-Object -ExpandProperty values
          Write-Output "Directories fetched as below:"
          $directories | ForEach-Object { Write-Output " - $($_.val)" }
          
          # Step 2: Loop through directories and aggregate counts per module
          foreach ($dirObj in $directories) {
          
            $dir = $dirObj.val
            $matchedModule = $null
            Write-Output "Next Directory during iteration is: $dir"
          
            # check if src of any key in modulePathMap matches the starting string of the current directory 
            foreach ($pathKey in $modulePathMap.Keys) {
              if ($dir -like "$pathKey*") {
                Write-Output "‚úÖ Match: '$dir' starts with '$pathKey'"
                $matchedModule = $modulePathMap[$pathKey]
                Write-Output "Matched module: $matchedModule"
                break
              } 
            } 
            # double check if any module has matched to account for current directory 
            if (-not $matchedModule) {
              Write-Output "‚ö† Skipping: '$dir' does not match any configured module"
              Write-Output " ‚ö† Current Directory does not fall under any configured module so will skip for now flagging it $dir"
              Write-Output " ‚ö† Also due to that mismatch $matchedModule is empty"
            } else {
                  if (-not $moduleAgg) {
                    Write-Output "‚ùå moduleAgg is NULL"
                  } else {
                  Write-Output "‚úÖ moduleAgg exists. Will execute severity checks and aggregate"  
                  if ($null -ne $moduleAgg[$matchedModule]) {
                  Write-Output "‚úÖ moduleAgg has a row for: $matchedModule and can be populated with severity numbers"
          
                  # now fetch severity-wise and then aggregate it
                    $sevList = "BLOCKER,CRITICAL,MAJOR,MINOR,INFO"
                    $sevUrl = "https://sonarcloud.io/api/issues/search?organization=$projectOrg&componentKeys=$projectKey&directories=$dir&severities=$sevList&issueStatuses=OPEN,CONFIRMED&resolved=false&ps=500"
                    $response = Invoke-WebRequest -Uri $sevUrl -Headers $headers -Method Get | ConvertFrom-Json
          
                    # Initialize counts
                    $counts = @{
                    BLOCKER = 0
                    HIGH    = 0
                    MEDIUM  = 0
                    LOW     = 0
                    INFO    = 0
                  }
          
                    foreach ($issue in $response.issues) {
                    switch ($issue.severity) {
                    "BLOCKER"  { $counts.BLOCKER++ }
                    "CRITICAL" { $counts.HIGH++ }
                    "MAJOR"    { $counts.MEDIUM++ }
                    "MINOR"    { $counts.LOW++ }
                    "INFO"     { $counts.INFO++ }
                  }
                  }
          
                  # Now add to moduleAgg
                    $moduleAgg[$matchedModule]["BLOCKER"] += $counts.BLOCKER
                    $moduleAgg[$matchedModule]["HIGH"]    += $counts.HIGH
                    $moduleAgg[$matchedModule]["MEDIUM"]  += $counts.MEDIUM
                    $moduleAgg[$matchedModule]["LOW"]     += $counts.LOW
                    $moduleAgg[$matchedModule]["INFO"]    += $counts.INFO
          
          
                } else {
                    Write-Output "‚ö† Unexpected: \$moduleAgg['$matchedModule'] is null. Skipping severity count."
                }
              } # end of else of check for $moduleAgg being null
            } # end of else of matchedModule not being found
          } # end step 2
          
          # Before moving to next step printing it in logs... 
          if (-not $moduleAgg) {
            Write-Output "‚ùå moduleAgg is NULL"
          }  else {
            Write-Output "‚úÖ moduleAgg exists. Current contents:"
            $moduleAgg.GetEnumerator() | ForEach-Object {
              $val = $_.Value
              if (-not $val) {
                Write-Output ("   ‚ö† Key = {0}, Value is NULL" -f $_.Key)
              }
              else {
                Write-Output ("   Key = {0}, Value = {1}" -f $_.Key, ($val | ConvertTo-Json -Compress))
              }
            }
            # Debug: Print out current aggregate state
            Write-Output "----- Current Module Aggregates -----"
            foreach ($moduleName in $moduleAgg.Keys) {
              $bucket = $moduleAgg[$moduleName]
              Write-Output ("Module: {0} | BLOCKER={1}, HIGH={2}, MEDIUM={3}, LOW={4}, INFO={5}" -f `
                            $moduleName, $bucket.BLOCKER, $bucket.HIGH, $bucket.MEDIUM, $bucket.LOW, $bucket.INFO)
            }
            Write-Output "--------------------------------------"
          }          

            # Step 3: Pretty-print module severity breakdown with conditional icons
            if ($moduleAgg.Count -gt 0) {
            echo "### üì¶ SonarCloud Module Severity Breakdown" >> $env:GITHUB_STEP_SUMMARY
            echo "| Module | üü• BLOCKER | üüß HIGH | üü® MEDIUM | üü¶ LOW  | ‚Ñπ INFO |" >> $env:GITHUB_STEP_SUMMARY
            echo "|--------|------------|---------|----------|--------|--------|" >> $env:GITHUB_STEP_SUMMARY
            foreach ($mod in $moduleAgg.Keys) {
            $b = $moduleAgg[$mod]
          
            function Mark($count) {
              if ($count -eq 0) { return "‚úÖ $count" }
              elseif ($count -le 5) { return "üü° $count" }
              else { return "üî¥ $count" }
            } # end of function Mark
          
            echo "| **$mod** | $(Mark $b.BLOCKER) | $(Mark $b.HIGH) | $(Mark $b.MEDIUM) | $(Mark $b.LOW) | $(Mark $b.INFO) |" >> $env:GITHUB_STEP_SUMMARY
            }
          }
          
          # Step 4: Export results as an output variable for email step
          # Example: "udemy_lpa_javamasterclass:0,2,15,5,0;misc_utils:0,1,8,4,0"
            $emailModuleSevAggBreakdown = ($moduleAgg.Keys | ForEach-Object {
              $b = $moduleAgg[$_]
              "${_}:$(Mark $b.BLOCKER),$(Mark $b.HIGH),$(Mark $b.MEDIUM),$(Mark $b.LOW),$(Mark $b.INFO)"
            }) -join ";"
          
          $emailModuleSevAggTable = "<table border='1' cellpadding='5' cellspacing='0'>"
          $emailModuleSevAggTable += "<tr><th>Module</th><th>BLOCKER</th><th>HIGH</th><th>MEDIUM</th><th>LOW</th><th>INFO</th></tr>"
          
          foreach ($entry in $emailModuleSevAggBreakdown -split ";") {
          $parts = $entry -split ":"
          if ($parts.Count -eq 2) {
          $module = $parts[0]
          $counts = $parts[1] -split ","
          $emailModuleSevAggTable += "<tr>"
          $emailModuleSevAggTable += "<td>$module</td>"
          foreach ($c in $counts) {
          $emailModuleSevAggTable += "<td align='center'>$c</td>"
          }
          $emailModuleSevAggTable += "</tr>"
          }
          }
          
          $emailModuleSevAggTable += "</table>"
          
          # Export both plain breakdown and HTML table
          echo "EMAIL_BREAKDOWN=$emailModuleSevAggBreakdown" >> $env:GITHUB_ENV
          echo "EMAIL_MODULE_SEV_AGG_TABLE=$emailModuleSevAggTable" >> $env:GITHUB_ENV 

      ###############################
      # Calculate Execution Metrics
      ##############################

      - name: Calculate and Publish Workflow Execution Metrics Action
        id: execution_metrics
        uses: ./.github/actions/publish-execution-metrics
        with:
          startTime: ${{ steps.start_time.outputs.startTime }}

        #      - name: Use output in summary
        #        run: |
        #          echo "Start Time: ${{ steps.execution_metrics.outputs.startTime }}"
        #          echo "End Time:   ${{ steps.execution_metrics.outputs.endTime }}"
        #          echo "Duration:   ${{ steps.execution_metrics.outputs.formattedDuration }}"

      ##########################
      # Email Success Summary
      ##########################

      - name: üìß Email Summary
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ vars.SMTP_SERVER_ADDRESS }}
          server_port: ${{ vars.SMTP_SERVER_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: >-
            ${{ job.status == 'success' && '‚úÖ SUCCESS' || '‚ùå FAILURE' }} 
            | Java MasterClass Hygiene Check for ${{ github.repository }} (main)
            ${{ steps.metrics.outputs.sonarCoverage && steps.metrics.outputs.sonarCoverage < 77 && '(‚ö†Ô∏è Coverage Below Threshold)' || '' }}

          to: ${{ vars.EMAIL_RECIPIENT }}
          from: GitHub Hygiene Bot <${{ vars.EMAIL_RECIPIENT }}>
          html_body: |
            <p>Hi Hemant,</p>
            <p>‚úÖ A GitHub Hygiene Check (CheckStyle, PMD, JaCoCo, SonarCloud) was completed on <strong>${{ github.repository }}</strong> (branch: <code>${{ env.TRIGGER_BRANCH }}</code>).</p>
            
            <p>üìä <strong>Hygiene Summary:</strong></p>
            <ul>
              <li>üìù <strong>Checkstyle Violations:</strong> <code>${{ steps.metrics.outputs.checkstyleCount }}</code></li>
              <li>üîç <strong>PMD Violations:</strong> <code>${{ steps.metrics.outputs.pmdCount }}</code></li>
              <li>üìà <strong>Code Coverage:</strong> <code>${{ steps.metrics.outputs.sonarCoverage }}</code></li>
              <li>üéØ <strong>Coverage Visual: <code>${{ steps.metrics.outputs.coverageBar }}</code></li>
              <li>üóÇ <strong>SonarCloud Total Issues:</strong><code>${{ steps.metrics.outputs.totalSonarFetchedIssues }}</code></li>
              <li>üåê <a href="${{ steps.metrics.outputs.sonarOverallCodeDashBoardURL }}"><code>View SonarCloud Overall Code Dashboard</code></a></li>
            </ul>
            
            <p>üõ† <strong>SonarCloud Severity Breakdown:</strong></p>
            <ul>
              <li>üü• <strong>BLOCKER:</strong><a href="${{ steps.metrics.outputs.sonarBlockerUrl }}"><code>${{ steps.metrics.outputs.sonarBlocker }}</code></a> ${{ steps.metrics.outputs.sonarBlockerEmojiMark }}</li>
              <li>üüß <strong>HIGH:</strong> <a href="${{ steps.metrics.outputs.sonarHighUrl }}"><code>${{ steps.metrics.outputs.sonarHigh }}</code></a> ${{ steps.metrics.outputs.sonarHighEmojiMark }}</li>
              <li>üü® <strong>MEDIUM:</strong> <a href="${{ steps.metrics.outputs.sonarMediumUrl }}"><code>${{ steps.metrics.outputs.sonarMedium }}</code></a> ${{ steps.metrics.outputs.sonarMediumEmojiMark }}</li>
              <li>üü¶ <strong>LOW:</strong> <a href="${{ steps.metrics.outputs.sonarLowUrl }}"><code>${{ steps.metrics.outputs.sonarLow }}</code></a> ${{ steps.metrics.outputs.sonarLowEmojiMark }}</li>
              <li>‚ÑπÔ∏è<strong>INFO:</strong> <a href="${{ steps.metrics.outputs.sonarInfoUrl }}"><code>${{ steps.metrics.outputs.sonarInfo }}</code></a> ${{ steps.metrics.outputs.sonarInfoEmojiMark }}</li>
              <li>üåê <a href="${{ steps.metrics.outputs.sonarOpenIssuesDashboardURL }}"><code>View SonarCloud Open Issues Breakdown Dashboard</code></a></li>
            </ul>
            
            <h3>üì¶ SonarCloud Module Severity Breakdown</h3>
            ${{ env.EMAIL_MODULE_SEV_AGG_TABLE }}

            <p>üì¶ <strong>Artifacts:</strong> <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"><code>Download from workflow run</code></a></p>
            <p>üìú <strong>Last Commit Info:</strong></p>
            <ul>
              <li>üåê <strong>Click Short SHA to view commit on GitHub:</strong> <a href="https://github.com/${{ github.repository }}/commit/${{ steps.execution_info.outputs.FULL_SHA }}"><code>${{ steps.execution_info.outputs.SHORT_SHA }}</code></a></li>
              <li><strong>Message:</strong> <code><em>${{ steps.execution_info.outputs.COMMIT_MSG }}</em></code></li>
              <li><strong>Author:</strong> <code>${{ steps.execution_info.outputs.COMMIT_AUTHOR }}</code></li>
              <li><strong>Date:</strong> <code>${{ steps.execution_info.outputs.COMMIT_DATE }}(${{ steps.execution_info.outputs.COMMIT_AGO }})</code></li>
            </ul>
            
            <p><strong>Github Job Execution Info:</strong></p>
            <ul>
                <li>${{ steps.execution_info.outputs.TRIGGER_INFO }}</li>
                <li>‚è± <strong>Start Time:</strong> <code>${{ steps.execution_metrics.outputs.startTime }}</code></li>
                <li>‚è± <strong>End Time:</strong> <code>${{ steps.execution_metrics.outputs.endTime }}</code></li>
                <li>‚è± <strong>Job Duration:</strong> <code>${{ steps.execution_metrics.outputs.formattedDuration }}</code></li>
            </ul>
            <hr style="dotted">
            <p><em>ü§ñ This is an automated message from a GitHub Actions workflow.<br>Please do not reply.</em></p>

      ###############################
        # FULL CLEANUP AND VERIFY
      ##############################

      - name: Full Cleanup and Verify Composite Call
        id: execution_metrics
        uses: ./.github/actions/full-cleanup-and-verify

      ###################################################################
      # DEMONSTRATES, FLAG BASED EXECUTION
      ##################################################################

      - name: ??? Say Hello (unless skipped)
        if: env.SKIP_ECHO != 'true'
        run: echo Hello, world!
        shell: cmd