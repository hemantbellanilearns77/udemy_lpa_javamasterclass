name: hygiene-checks

on:
  push:
    branches: [main]
  pull_request:

jobs:
  run-hygiene:
    runs-on: windows-latest
    env:
      JACOCO_MIN_COVERAGE: 80

    steps:
      - name: ðŸ§¾ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 24

      # --------------------------------------
      # CHECKSTYLE
      # --------------------------------------
      - name: ðŸ“¥ Download Checkstyle
        run: |
          mkdir tools\checkstyle
          curl -L -o tools\checkstyle\checkstyle-10.12.2-all.jar https://repo1.maven.org/maven2/com/puppycrawl/tools/checkstyle/10.12.2/checkstyle-10.12.2-all.jar
        shell: cmd

      - name: ðŸ“‹ Run Checkstyle
        run: |
          java -jar tools\checkstyle\checkstyle-10.12.2-all.jar ^
            -c config/checkstyle/checkstyle.xml ^
            -f plain ^
            -o reports/checkstyle/checkstyle-result.txt ^
            src/main/java misc_utils/src/main/java
        shell: cmd
        continue-on-error: true

      - name: ðŸ“¤ Upload Checkstyle Report
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: reports/checkstyle/checkstyle-result.txt

      # --------------------------------------
      # PMD
      # --------------------------------------
      - name: ðŸ“¥ Download PMD
        run: |
          curl -L -o tools\pmd-bin.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F6.55.0/pmd-bin-6.55.0.zip
          powershell -command "Expand-Archive -Path tools\pmd-bin.zip -DestinationPath tools\pmd"
        shell: cmd

      - name: ðŸ” Run PMD
        run: |
          tools\pmd\pmd-bin-6.55.0\bin\pmd.bat ^
            -d src\main\java,misc_utils\src\main\java ^
            -R config\pmd\ruleset.xml ^
            -f text ^
            -r reports\pmd\pmd-report.txt
        shell: cmd
        continue-on-error: true

      - name: ðŸ“¤ Upload PMD Report
        uses: actions/upload-artifact@v4
        with:
          name: pmd-report
          path: reports/pmd/pmd-report.txt

      # --------------------------------------
      # JACOCO
      # --------------------------------------
      - name: ðŸ“¥ Download JaCoCo + JUnit Console
        run: |
          mkdir tools\jacoco-0.8.13\lib
          curl -L -o tools\jacoco-0.8.13\lib\jacocoagent.jar https://repo1.maven.org/maven2/org/jacoco/org.jacoco.agent/0.8.13/org.jacoco.agent-0.8.13-runtime.jar
          curl -L -o tools\jacoco-0.8.13\lib\jacococli.jar https://repo1.maven.org/maven2/org/jacoco/org.jacoco.cli/0.8.13/org.jacoco.cli-0.8.13-nodeps.jar
          mkdir tools\junit-console
          curl -L -o tools\junit-console\junit-platform-console-standalone-1.13.0.jar https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.13.0/junit-platform-console-standalone-1.13.0.jar
        shell: cmd

      - name: ðŸ› ï¸ Compile Modules (if Needed)
        shell: cmd
        run: |
          set "OUT_PROD=out\production"
          set "OUT_TEST=out\test"
          set "JUNIT_JAR=tools\junit-console\junit-platform-console-standalone-1.13.0.jar"
          if not exist "%OUT_PROD%\udemy_lpa_javamasterclass" (
            if not exist "%OUT_PROD%\misc_utils" (
              echo âš™ Compiling modules...
              rmdir /s /q "%OUT_PROD%" >nul 2>&1
              rmdir /s /q "%OUT_TEST%" >nul 2>&1
              mkdir "%OUT_PROD%\udemy_lpa_javamasterclass"
              mkdir "%OUT_PROD%\misc_utils"
              mkdir "%OUT_TEST%\udemy_lpa_javamasterclass"
              mkdir "%OUT_TEST%\misc_utils"
              dir /s /b src\main\java\*.java > sources_main.txt
              javac --enable-preview --release 24 -encoding UTF-8 -d "%OUT_PROD%\udemy_lpa_javamasterclass" @sources_main.txt
              dir /s /b misc_utils\src\main\java\*.java > sources_misc.txt
              javac --enable-preview --release 24 -encoding UTF-8 -cp "%OUT_PROD%\udemy_lpa_javamasterclass" -d "%OUT_PROD%\misc_utils" @sources_misc.txt
              dir /s /b src\test\java\*.java > sources_test_main.txt
              javac --enable-preview --release 24 -encoding UTF-8 -cp "%OUT_PROD%\udemy_lpa_javamasterclass;%OUT_PROD%\misc_utils;%JUNIT_JAR%" -d "%OUT_TEST%\udemy_lpa_javamasterclass" @sources_test_main.txt
              if exist "misc_utils\src\test\java" (
                dir /s /b misc_utils\src\test\java\*.java > sources_test_misc.txt
                javac --enable-preview --release 24 -encoding UTF-8 -cp "%OUT_PROD%\udemy_lpa_javamasterclass;%OUT_PROD%\misc_utils;%JUNIT_JAR%" -d "%OUT_TEST%\misc_utils" @sources_test_misc.txt
              )
              del sources_*.txt
            )
          )

      - name: ðŸ§ª Run JaCoCo Coverage Analysis
        run: scripts\run-coverage-analysis.bat
        shell: cmd

      - name: ðŸ“¤ Upload JaCoCo Reports
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-reports
          path: |
            reports/jacoco
            logs/jacoco-logs

      # --------------------------------------
      # SUMMARY (All Tools)
      # --------------------------------------
      - name: ðŸ“Š Add Summary to GitHub UI
        shell: pwsh
        run: |
          $coverage = Select-Xml -Path reports\jacoco\jacoco-latest.xml -XPath "//report/counter[@type='INSTRUCTION']"
          $missed = [int]$coverage.Node.missed
          $covered = [int]$coverage.Node.covered
          $total = $missed + $covered
          if ($total -gt 0) {
            $percent = [math]::Round(100 * $covered / $total, 2)
          } else {
            $percent = 0
          }

          echo "### ðŸ§¼ Hygiene Summary" >> $env:GITHUB_STEP_SUMMARY
          echo "| Tool       | Result     |" >> $env:GITHUB_STEP_SUMMARY
          echo "|------------|------------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| Checkstyle | See logs   |" >> $env:GITHUB_STEP_SUMMARY
          echo "| PMD        | See logs   |" >> $env:GITHUB_STEP_SUMMARY
          echo "| JaCoCo     | $percent% coverage |" >> $env:GITHUB_STEP_SUMMARY

          if ($percent -lt $env:JACOCO_MIN_COVERAGE) {
            echo "âš ï¸ Warning: Coverage $percent% is below threshold $env:JACOCO_MIN_COVERAGE%" >> $env:GITHUB_STEP_SUMMARY
          }

      # --------------------------------------
      # CLEANUP
      # --------------------------------------
      - name: ðŸ§¹ Final Cleanup (source list files)
        if: always()
        shell: cmd
        run: del /q sources_*.txt 2>nul || exit 0
