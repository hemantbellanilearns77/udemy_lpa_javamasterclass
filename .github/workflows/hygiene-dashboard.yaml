name: Hygiene Checks Pipeline

on:
  push:
    branches: [ main ]

jobs:
  hygiene-checks:
    name: Hygiene Checks - Checkstyle + PMD + JaCoCo + Sonar
    runs-on: windows-latest
    env:
      JACOCO_MIN_COVERAGE: 0.05
      CHECKSTYLE_PMD_MAX_TOTAL_VIOLATIONS: 50
      CHECKSTYLE_MAX_VIOLATIONS: 16000
      PMD_MAX_VIOLATIONS: 63
      SONAR_ORG: ${{ vars.SONAR_ORG }}
      SONAR_PROJECT_KEY: ${{ vars.SONAR_PROJECT_KEY }}
      SKIP_ECHO: false

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚òï Setup JDK 24 (for JaCoCo + Compilation)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 24

      ##########################
      # DOWNLOAD TOOLS
      ##########################

      - name: üì¶ Download Checkstyle
        run: |
          mkdir tools\checkstyle
          curl -L -o tools\checkstyle\checkstyle-10.26.1-all.jar https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.26.1/checkstyle-10.26.1-all.jar

      - name: üì¶ Download and Extract PMD
        run: curl -L -o pmd.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.15.0/pmd-dist-7.15.0-bin.zip
        shell: bash

      - name: üì¶ Extract PMD
        run: |
          mkdir tools\pmd
          powershell -Command "Expand-Archive -Path 'pmd.zip' -DestinationPath 'tools\pmd'"
        shell: cmd

      - name: üì¶ Download JaCoCo + JUnit Console
        run: |
          mkdir tools\jacoco-0.8.13\lib
          curl -L -o tools\jacoco-0.8.13\lib\jacocoagent.jar https://repo1.maven.org/maven2/org/jacoco/org.jacoco.agent/0.8.13/org.jacoco.agent-0.8.13-runtime.jar
          curl -L -o tools\jacoco-0.8.13\lib\jacococli.jar https://repo1.maven.org/maven2/org/jacoco/org.jacoco.cli/0.8.13/org.jacoco.cli-0.8.13-nodeps.jar
          mkdir tools\junit-console
          curl -L -o tools\junit-console\junit-platform-console-standalone-1.13.0.jar https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.13.0/junit-platform-console-standalone-1.13.0.jar
        shell: cmd

      ##########################
      # RUN STATIC ANALYSIS
      ##########################

      - name: üßº Run Checkstyle
        run: scripts\run-checkstyle.bat

      - name: üßº Run PMD
        run: scripts\run-pmd.bat
        shell: cmd

      ##########################
      # COMPILE + JACOCO
      ##########################

      - name: üõ†Ô∏è Compile Java Modules if Needed
        shell: cmd
        run: |
          set "JAVA_HOME=%JAVA_HOME%"
          set "OUT_PROD=out\production"
          set "OUT_TEST=out\test"
          set "SRC_MAIN=src\main\java"
          set "SRC_MISC=misc_utils\src\main\java"
          set "TEST_MAIN=src\test\java"
          set "TEST_MISC=misc_utils\src\test\java"
          set "JUNIT_JAR=tools\junit-console\junit-platform-console-standalone-1.13.0.jar"

          if not exist "%OUT_PROD%\udemy_lpa_javamasterclass" (
            if not exist "%OUT_PROD%\misc_utils" (
              echo ‚öô Compilation triggered

              rmdir /s /q "%OUT_PROD%" >nul 2>&1
              rmdir /s /q "%OUT_TEST%" >nul 2>&1

              mkdir "%OUT_PROD%\udemy_lpa_javamasterclass"
              mkdir "%OUT_PROD%\misc_utils"
              mkdir "%OUT_TEST%\udemy_lpa_javamasterclass"
              mkdir "%OUT_TEST%\misc_utils"

              echo ‚úç Compiling udemy_lpa_javamasterclass
              dir /s /b "%SRC_MAIN%\*.java" > sources_main.txt
              javac --enable-preview --release 24 -encoding UTF-8 -d "%OUT_PROD%\udemy_lpa_javamasterclass" @sources_main.txt

              echo ‚úç Compiling misc_utils
              dir /s /b "%SRC_MISC%\*.java" > sources_misc.txt
              javac --enable-preview --release 24 -encoding UTF-8 -cp "%OUT_PROD%\udemy_lpa_javamasterclass" -d "%OUT_PROD%\misc_utils" @sources_misc.txt

              echo ‚úç Compiling tests (masterclass)
              dir /s /b "%TEST_MAIN%\*.java" > sources_test_main.txt
              javac --enable-preview --release 24 -encoding UTF-8 -cp "%OUT_PROD%\udemy_lpa_javamasterclass;%OUT_PROD%\misc_utils;%JUNIT_JAR%" -d "%OUT_TEST%\udemy_lpa_javamasterclass" @sources_test_main.txt

              echo ‚úç Compiling tests (misc_utils)
              if exist "%TEST_MISC%" (
                dir /s /b "%TEST_MISC%\*.java" > sources_test_misc.txt
                javac --enable-preview --release 24 -encoding UTF-8 -cp "%OUT_PROD%\udemy_lpa_javamasterclass;%OUT_PROD%\misc_utils;%JUNIT_JAR%" -d "%OUT_TEST%\misc_utils" @sources_test_misc.txt
              )

              del sources_main.txt sources_misc.txt sources_test_main.txt sources_test_misc.txt
            )
          )

      - name: üß™ Run JaCoCo Coverage
        run: scripts\run-coverage-analysis.bat
        shell: cmd

      ##########################
      # UPLOAD REPORTS
      ##########################

      - name: ‚¨ÜÔ∏è Upload All Reports
        uses: actions/upload-artifact@v4
        with:
          name: hygiene-reports
          path: |
            reports/**
            logs/**

      ##########################
      # DOWNLOAD SONAR-SCANNER
      ##########################

      - name: üì¶ Download and Setup SonarScanner 7.1.0.4889
        shell: bash
        run: |
          curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-7.1.0.4889-windows-x64.zip
          mkdir tools/sonar-scanner
          unzip sonar-scanner.zip -d tools/sonar-scanner
          echo "SONAR_SCANNER_HOME=$PWD/tools/sonar-scanner-7.1.0.4889-windows" >> $GITHUB_ENV
          echo "$PWD/tools/sonar-scanner/sonar-scanner-7.1.0.4889-windows/bin" >> $GITHUB_PATH
          
      ################################
          # RUN SONAR CLOUD ANALYSIS
      ################################
      - name: üîé Run SonarCloud Scan (via batch)
        if: success()
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: scripts\run-sonar-scan-admin.bat
        shell: cmd

      ##########################
      # SUMMARY SECTION
      ##########################

      - name: üìä Add Hygiene Summary (Checkstyle + PMD + JaCoCo)
        id: metrics
        shell: pwsh
        run: |
          # Parse JaCoCo XML
          $xml = Select-Xml -Path reports\jacoco\jacoco-latest.xml -XPath "//report/counter[@type='INSTRUCTION']"
          $missed = [int]$xml.Node.missed
          $covered = [int]$xml.Node.covered
          $total = $missed + $covered
          if ($total -gt 0) {
            $jacocoCoverage = [math]::Round(100 * $covered / $total, 2)
          } else {
            $jacocoCoverage = 0
          }

          # Parse Checkstyle violations
          $checkstyleViolations = 0
          if (Test-Path "reports/checkstyle") {
            Get-ChildItem reports/checkstyle/*.txt | ForEach-Object {
              $checkstyleViolations += (Get-Content $_ | Where-Object { $_.Trim() -ne "" }).Count
            }
          }

          # Parse PMD violations
          $pmdViolations = 0
          if (Test-Path "reports/pmd") {
            Get-ChildItem reports/pmd/*.txt | ForEach-Object {
              $pmdViolations += (Get-Content $_ | Where-Object { $_ -match "^[A-Za-z]:\\" }).Count
            }
          }

          $totalViolations = $checkstyleViolations + $pmdViolations

          # Write summary
          echo "### üß™ Hygiene Summary (Checkstyle + PMD + JaCoCo)" >> $env:GITHUB_STEP_SUMMARY
          echo "|               **Metrics**         |      **Values**      |" >> $env:GITHUB_STEP_SUMMARY
          echo "|-----------------------------------|----------------------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| Checkstyle Violations             | $checkstyleViolations|" >> $env:GITHUB_STEP_SUMMARY
          echo "| PMD Code Smells                   | $pmdViolations       |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Total (PMD=CHECKSTYLE) Violations | $totalViolations     |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Coverage                          | $jacocoCoverage%     |" >> $env:GITHUB_STEP_SUMMARY
          
          
          # === SonarCloud Dashboard Link ===
          $org = $env:SONAR_ORG
          $projectKey = $env:SONAR_PROJECT_KEY
          $branch = "${{ github.ref_name }}"
          $sonarUrl = "https://sonarcloud.io/dashboard?id=$projectKey&branch=$branch"
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "üîó [View full SonarCloud Report]($sonarUrl)" >> $env:GITHUB_STEP_SUMMARY
          
          echo "CHECKSTYLE_VIOLATIONS=$checkstyleViolations" >> $GITHUB_ENV
          echo "PMD_VIOLATIONS=$pmdViolations" >> $GITHUB_ENV
          echo "JACOCO_COVERAGE_PERCENT=$jacocoCoverage%" >> $GITHUB_ENV
          echo "SONARCLOUD_DASHBOARD_URL=$sonarUrl" >> $GITHUB_ENV
          
          echo "checkstyleCount=$checkstyleViolations" >> $GITHUB_OUTPUT 
          echo "pmdCount=$pmdViolations" >> $GITHUB_OUTPUT
          echo "jacocoPercent=$jacocoCoverage%" >> $GITHUB_OUTPUT
          echo "sonarURL=$sonarUrl" >> $GITHUB_OUTPUT
          
          if ($jacocoCoverage -lt $env:JACOCO_MIN_COVERAGE) {
            echo "‚ö†Ô∏è Warning: Coverage $jacocoCoverage% is below threshold $env:JACOCO_MIN_COVERAGE%" >> $env:GITHUB_STEP_SUMMARY
          } else {
            echo "**‚úÖ Good Coverage Levels in code!** Great job! üéâ" >> $env:GITHUB_STEP_SUMMARY
          }
          
          if ($totalViolations -eq 0) {
            echo "**‚úÖ Clean Code!** Great job! üéâ" >> $env:GITHUB_STEP_SUMMARY
          } elseif ($totalViolations -lt $env:CHECKSTYLE_PMD_MAX_TOTAL_VIOLATIONS) {
            echo "**üü° Moderate Violations ‚Äî please review.**" >> $env:GITHUB_STEP_SUMMARY
          } else {
            echo "**‚ùå High Violations ‚Äî requires attention.**" >> $env:GITHUB_STEP_SUMMARY
          }
          $shouldFail = $false
          
          if ($jacocoCoverage -lt $env:JACOCO_MIN_COVERAGE) {
          echo "‚ö†Ô∏è Warning: Coverage $jacocoCoverage% is below threshold $env:JACOCO_MIN_COVERAGE%" >> $env:GITHUB_STEP_SUMMARY
          $shouldFail = $true
          }

          if ($checkstyleViolations -gt $env:CHECKSTYLE_MAX_VIOLATIONS) {
            echo "‚ùå Checkstyle violations ($checkstyleViolations) exceed threshold ($env:CHECKSTYLE_MAX_VIOLATIONS)" >> $env:GITHUB_STEP_SUMMARY
            $shouldFail = $true
          }

          if ($pmdViolations -gt $env:PMD_MAX_VIOLATIONS) {
            echo "‚ùå PMD violations ($pmdViolations) exceed threshold ($env:PMD_MAX_VIOLATIONS)" >> $env:GITHUB_STEP_SUMMARY
            $shouldFail = $true
          }
          # Outcome message
          if ($totalViolations -eq 0 -and -not $shouldFail) {
            echo "**‚úÖ Clean Code!** Great job! üéâ" >> $env:GITHUB_STEP_SUMMARY
          } elseif ($shouldFail) {
            echo "**‚ùå Failing due to threshold violations.**" >> $env:GITHUB_STEP_SUMMARY
            exit 1
          } else {
            echo "**‚ö†Ô∏è Some issues found, but within threshold.**" >> $env:GITHUB_STEP_SUMMARY
          }


          
          ##########################
      # FULL CLEANUP
      ##########################

      - name: üßπ Full Cleanup
        shell: cmd
        run: |
          echo Cleaning up temp artifacts
          rmdir /s /q out >nul 2>&1
          rmdir /s /q logs >nul 2>&1
          rmdir /s /q reports >nul 2>&1
          del /q sources_*.txt >nul 2>&1
          echo ‚úÖ Cleanup done 

      ##########################
      # CLEANUP VERIFICATION
      ##########################
      - name: üìÇ List Remaining Files
        shell: cmd
        run: |
          echo === POST-CLEANUP DIRECTORY TREE ===
          dir /s /b

      - name: üó£Ô∏è Say Hello (unless skipped)
        if: env.SKIP_ECHO != 'true'
        run: echo Hello, world!
        shell: cmd

      ##########################
      # Email Success Summary
      ##########################

      - name: üì¨ Email Summary
        uses: dawidd6/action-send-mail@v3
        env:
          CHECKSTYLE_VIOLATIONS: 25
          PMD_VIOLATIONS: ${{ steps.metrics.outputs.pmdCount }}
          JACOCO_COVERAGE_PERCENT: ${{ steps.metrics.outputs.jacocoPercent }}
          SONARCLOUD_DASHBOARD_URL: ${{ steps.metrics.outputs.sonarURL }}
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: GitHub Hygiene Summary - ${{ github.repository }}
          to: hemantbellanilearns77@gmail.com
          from: GitHub Hygiene Bot <hemantbellanilearns77@gmail.com>
          body: |
            Dear Recipient,
            A GitHub Hygiene Check ( CheckStyle + PMD + Jacoco + Sonar ) workflow just executed on the ${{ github.repository }} repository successfully. 
            
            Here is the Hygiene Summary:
            - ‚úÖ Checkstyle Violations: ${{ env.CHECKSTYLE_VIOLATIONS }} 
            - ‚úÖ PMD Violations: ${{ env.PMD_VIOLATIONS }}
            - ‚úÖ Code Coverage: ${{ env.JACOCO_COVERAGE_PERCENT }} %
            - "üîó [View full SonarCloud Report](${{ env.SONARCLOUD_DASHBOARD_URL }})" 
            
            
            P.S.> This is an automated message from a Github Workflow's Email Step. Please do not reply to this email.
