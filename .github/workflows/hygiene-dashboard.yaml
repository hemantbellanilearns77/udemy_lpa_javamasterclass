name: Code Hygiene

on:
  push:
    branches: [main]

jobs:
  hygiene-checks:
    runs-on: windows-latest
    env:
      JACOCO_MIN_COVERAGE: 80

    steps:
      - name: ðŸ§¾ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 24

      - name: ðŸ“¦ Download Required Tools
        run: |
          mkdir tools\jacoco-0.8.13\lib
          curl -L -o tools\jacoco-0.8.13\lib\jacocoagent.jar https://repo1.maven.org/maven2/org/jacoco/org.jacoco.agent/0.8.13/org.jacoco.agent-0.8.13-runtime.jar
          curl -L -o tools\jacoco-0.8.13\lib\jacococli.jar https://repo1.maven.org/maven2/org/jacoco/org.jacoco.cli/0.8.13/org.jacoco.cli-0.8.13-nodeps.jar
          mkdir tools\junit-console
          curl -L -o tools\junit-console\junit-platform-console-standalone-1.13.0.jar https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.13.0/junit-platform-console-standalone-1.13.0.jar
        shell: cmd

      # 1ï¸âƒ£ CHECKSTYLE
      - name: ðŸ” Run Checkstyle
        run: |
          mkdir reports\checkstyle
          curl -L -o checkstyle-10.12.3-all.jar https://repo1.maven.org/maven2/com/puppycrawl/tools/checkstyle/10.12.3/checkstyle-10.12.3-all.jar
          java -jar checkstyle-10.12.3-all.jar -c config/checkstyle/checkstyle.xml -f xml -o reports/checkstyle/checkstyle-result.xml src/main/java misc_utils/src/main/java
        shell: cmd

      # 2ï¸âƒ£ PMD
      - name: ðŸ§¹ Run PMD
        run: |
          curl -L -o pmd-bin.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.0.0/pmd-dist-7.0.0-bin.zip
          tar -xf pmd-bin.zip
          pmd-bin-7.0.0/bin/pmd.bat check -d src/main/java,misc_utils/src/main/java -R config/pmd/ruleset.xml -f xml -r reports/pmd/pmd-result.xml
        shell: cmd

      # 3ï¸âƒ£ JACOCO
      - name: ðŸ§ª Run JaCoCo Coverage
        run: scripts\run-coverage-analysis.bat
        shell: cmd

      # 4ï¸âƒ£ SUMMARY
      - name: ðŸ“Š Add Summary to GitHub UI
        shell: pwsh
        run: |
          $summaryPath = $env:GITHUB_STEP_SUMMARY

          echo "## ðŸ§¼ Code Hygiene Summary" >> $summaryPath
          echo "" >> $summaryPath

          # âœ… JaCoCo Coverage
          $xml = Select-Xml -Path reports\jacoco\jacoco-latest.xml -XPath "//report/counter[@type='INSTRUCTION']"
          $missed = [int]$xml.Node.missed
          $covered = [int]$xml.Node.covered
          $total = $missed + $covered
          $percent = if ($total -gt 0) { [math]::Round(100 * $covered / $total, 2) } else { 0 }
          echo "### ðŸ§ª Code Coverage (JaCoCo)" >> $summaryPath
          echo "| Metric    | Value     |" >> $summaryPath
          echo "|-----------|-----------|" >> $summaryPath
          echo "| Covered   | $covered  |" >> $summaryPath
          echo "| Missed    | $missed   |" >> $summaryPath
          echo "| Total     | $total    |" >> $summaryPath
          echo "| Coverage  | $percent% |" >> $summaryPath
          if ($percent -lt $env:JACOCO_MIN_COVERAGE) {
            echo "**âš ï¸ Warning: Coverage $percent% is below threshold $env:JACOCO_MIN_COVERAGE%**" >> $summaryPath
          }
          echo "" >> $summaryPath

          # âœ… Checkstyle
          if (Test-Path "reports/checkstyle/checkstyle-result.xml") {
            $checkstyleCount = (Select-Xml -Path reports/checkstyle/checkstyle-result.xml -XPath "//file/error").Count
            echo "### ðŸ” Checkstyle" >> $summaryPath
            echo "**Violations:** $checkstyleCount" >> $summaryPath
            if ($checkstyleCount -gt 0) {
              echo "> âš ï¸ Please fix Checkstyle issues in source code" >> $summaryPath
            }
            echo "" >> $summaryPath
          }

          # âœ… PMD
          if (Test-Path "reports/pmd/pmd-result.xml") {
            $pmdCount = (Select-Xml -Path reports/pmd/pmd-result.xml -XPath "//violation").Count
            echo "### ðŸ§¹ PMD" >> $summaryPath
            echo "**Violations:** $pmdCount" >> $summaryPath
            if ($pmdCount -gt 0) {
              echo "> âš ï¸ Please address PMD rule violations" >> $summaryPath
            }
          }

      # 5ï¸âƒ£ CLEANUP
      - name: ðŸ§¼ Cleanup temp files
        run: |
          del /q *.txt *.jar *.zip >nul 2>&1
        shell: cmd

      - name: ðŸ“¤ Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: code-hygiene-reports
          path: |
            reports/
            logs/
