name: Demo All-in-One Dashboard

on:
  workflow_dispatch: # run manually for demo

jobs:
  analysis:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin

      # 1. Run Checkstyle
      - name: Run Checkstyle
        uses: nikitasavinov/checkstyle-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: 'sarif'
          checkstyle_config: 'google' # change to your own if you have custom
      - name: Upload Checkstyle SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkstyle-result.sarif

      # 2. Run PMD
      - name: Run PMD
        uses: pmd/pmd-github-action@v1
        with:
          rulesets: "rulesets/java/quickstart.xml"
          sourcePath: "src/main/java"
          encoding: "UTF-8"
          format: "sarif"
          outputFile: "pmd-result.sarif"
      - name: Upload PMD SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pmd-result.sarif

      # 3. Run JUnit + Jacoco via Maven (needs pom.xml)
      - name: Run Tests with Coverage
        run: mvn -B test jacoco:report

      # 4. SonarCloud scan using your actual sonar-project.properties
      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.3.1
        with:
          args: >
            -Dproject.settings=sonar-project.properties
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }}
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      # 5. Publish a simple HTML summary page to GitHub Pages
      - name: Generate Static Dashboard
        shell: pwsh
        run: |
          mkdir site
          echo "<h1>Demo Dashboard</h1>" >> site/index.html
          echo "<h2>Checkstyle, PMD, Jacoco Reports</h2>" >> site/index.html
          echo "<p>✅ Checkstyle + PMD issues are visible in the GitHub Security tab</p>" >> site/index.html
          echo "<p>✅ Jacoco report available at target/site/jacoco/index.html (in artifacts)</p>" >> site/index.html
          echo "<p>✅ SonarCloud dashboard: https://sonarcloud.io/project/overview?id=hemantbellanilearns77_udemy_lpa_javamasterclass</p>" >> site/index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
