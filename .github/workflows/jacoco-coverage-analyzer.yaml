name: JaCoCo Coverage

on:
  push:
    branches: [main]

jobs:
  jacoco-coverage:
    runs-on: windows-latest

    env:
      JACOCO_MIN_COVERAGE: "80"

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: ☕ Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 📦 Setup JaCoCo + JUnit Console
        run: |
          mkdir tools\jacoco\lib
          curl -L -o tools\jacoco\lib\jacocoagent.jar https://repo1.maven.org/maven2/org/jacoco/org.jacoco.agent/0.8.13/org.jacoco.agent-0.8.13-runtime.jar
          curl -L -o tools\jacoco\lib\jacococli.jar https://repo1.maven.org/maven2/org/jacoco/org.jacoco.cli/0.8.13/org.jacoco.cli-0.8.13-nodeps.jar
          mkdir tools\junit-console
          curl -L -o tools\junit-console\junit-platform-console-standalone-1.13.0.jar https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.13.0/junit-platform-console-standalone-1.13.0.jar

      - name: ▶️ Run JaCoCo Coverage
        run: scripts\run-coverage-analysis.bat

      - name: ⬆️ Upload Coverage Reports
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-reports
          path: |
            reports\jacoco\*.xml
            reports\jacoco\*.exec
            reports\jacoco\report-*\**
            logs\jacoco-logs\*.txt

      - name: 📊 Publish GitHub Summary (Configurable Threshold)
        shell: bash
        run: |
          echo "### ☂️ Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          coverage=$(grep -oP '(?<=<counter type="INSTRUCTION" missed=")[0-9]+' reports/jacoco/jacoco-latest.xml | head -1)
          covered=$(grep -oP '(?<=covered=")[0-9]+' reports/jacoco/jacoco-latest.xml | head -1)
          percent=$(awk "BEGIN { if (($coverage + $covered) > 0) print 100*$covered/($coverage + $covered); else print 0 }")

          echo "| Metric       | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage     | $percent% |" >> $GITHUB_STEP_SUMMARY
          echo "| Threshold    | $JACOCO_MIN_COVERAGE% |" >> $GITHUB_STEP_SUMMARY

          if (( $(echo "$percent < $JACOCO_MIN_COVERAGE" | bc -l) )); then
            echo "| Status       | ⚠️ BELOW THRESHOLD |" >> $GITHUB_STEP_SUMMARY
            echo "Coverage below threshold but not failing job (configurable)." >> $GITHUB_STEP_SUMMARY
            # exit 1  # <-- commented out for now
          else
            echo "| Status       | ✅ OK |" >> $GITHUB_STEP_SUMMARY
          fi
