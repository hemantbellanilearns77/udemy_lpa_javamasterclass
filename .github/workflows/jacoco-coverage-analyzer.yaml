name: JaCoCo Coverage

on:
  push:
    branches: [main]

jobs:
  jacoco-coverage:
    runs-on: windows-latest
    env:
      JACOCO_MIN_COVERAGE: 80

    steps:
      - name: 🧾 Checkout Code
        uses: actions/checkout@v4

      - name: ☕ Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17

      - name: 📦 Download JaCoCo + JUnit Console
        run: |
          mkdir tools\jacoco-0.8.13\lib
          curl -L -o tools\jacoco-0.8.13\lib\jacocoagent.jar https://repo1.maven.org/maven2/org/jacoco/org.jacoco.agent/0.8.13/org.jacoco.agent-0.8.13-runtime.jar
          curl -L -o tools\jacoco-0.8.13\lib\jacococli.jar https://repo1.maven.org/maven2/org/jacoco/org.jacoco.cli/0.8.13/org.jacoco.cli-0.8.13-nodeps.jar
          mkdir tools\junit-console
          curl -L -o tools\junit-console\junit-platform-console-standalone-1.13.0.jar https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.13.0/junit-platform-console-standalone-1.13.0.jar
        shell: cmd

      - name: 🔧 Compile Classes If Needed
        shell: pwsh
        run: |
          $needCompile = $true
          $paths = @(
            "out/production/udemy_lpa_javamasterclass",
            "out/production/misc_utils",
            "out/test/udemy_lpa_javamasterclass",
            "out/test/misc_utils"
          )
          foreach ($path in $paths) {
            if (Test-Path $path) {
              $needCompile = $false
              break
            }
          }
          if ($needCompile) {
            echo "⚙ Compiling Java sources..."
            mkdir out/production/udemy_lpa_javamasterclass -ea SilentlyContinue
            mkdir out/production/misc_utils -ea SilentlyContinue
            mkdir out/test/udemy_lpa_javamasterclass -ea SilentlyContinue
            mkdir out/test/misc_utils -ea SilentlyContinue

            Get-ChildItem -Recurse src/main/java -Filter *.java | ForEach-Object {
              javac -d out/production/udemy_lpa_javamasterclass $_.FullName
            }
            Get-ChildItem -Recurse misc_utils/src/main/java -Filter *.java | ForEach-Object {
              javac -d out/production/misc_utils $_.FullName
            }
            Get-ChildItem -Recurse src/test/java -Filter *.java | ForEach-Object {
              javac -cp out/production/udemy_lpa_javamasterclass -d out/test/udemy_lpa_javamasterclass $_.FullName
            }
            Get-ChildItem -Recurse misc_utils/src/test/java -Filter *.java | ForEach-Object {
              javac -cp out/production/misc_utils -d out/test/misc_utils $_.FullName
            }
          } else {
            echo "✅ Class files found, skipping compilation."
          }

      - name: 🧪 Run Coverage Script
        run: scripts\run-coverage-analysis.bat

      - name: 📤 Upload JaCoCo Reports
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-reports
          path: |
            reports/jacoco
            logs/jacoco-logs

      - name: 📊 Add Coverage Summary to UI
        shell: pwsh
        run: |
          $xml = Select-Xml -Path reports\jacoco\jacoco-latest.xml -XPath "//report/counter[@type='INSTRUCTION']"
          $missed = [int]$xml.Node.missed
          $covered = [int]$xml.Node.covered
          $total = $missed + $covered
          if ($total -gt 0) {
            $percent = [math]::Round(100 * $covered / $total, 2)
          } else {
            $percent = 0
          }

          echo "### 🧪 JaCoCo Coverage Summary" >> $env:GITHUB_STEP_SUMMARY
          echo "| Metric    | Value     |" >> $env:GITHUB_STEP_SUMMARY
          echo "|-----------|-----------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| Covered   | $covered   |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Missed    | $missed    |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Total     | $total     |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Coverage  | $percent%  |" >> $env:GITHUB_STEP_SUMMARY

          if ($percent -lt $env:JACOCO_MIN_COVERAGE) {
            echo "⚠️ Warning: Coverage $percent% is below threshold $env:JACOCO_MIN_COVERAGE%" >> $env:GITHUB_STEP_SUMMARY
          }
