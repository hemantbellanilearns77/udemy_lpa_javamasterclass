##############################################################
    # EVALUATE METRICS and STATUS and PUBLISH SUMMARIES
##############################################################
name: "EVALUATE METRICS and STATUS and PUBLISH SUMMARIES"
description: ""
inputs:
  startTime:
    description: "Start time from setup-start time composite"
    required: true
  SKIP_FLAG:
    required: true
    description: ""
  COMMIT_MSG:
    required: true
    description: ""
  COMMIT_AUTHOR:
    required: true
    description: ""
  TRIGGER_EVENT:
    required: true
    description: ""
  SRC_BRANCH:
    required: true
    description: ""
  TGT_BRANCH:
    required: true
    description: ""
  BRANCH_EXECUTED:
    required: true
    description: ""
  ARTIFACT_URL:
    required: true
    description: ""
  STAGE_VS_MAIN_STATE:
    required: true
    description: "Indicates if stage merge was skipped"
  JOB_STATUS:
    required: true
    description: ""

outputs:
  sonarExecutionNote:
    description: ""
    value: ${{ steps.sonar-vars.outputs.sonarExecutionNote }}
  sonarIssuesNote:
    description: ""
    value: ${{ steps.sonar-vars.outputs.sonarIssuesNote }}
  lastSonarAnalysis:
    description: ""
    value: ${{ steps.sonar-vars.outputs.lastSonarAnalysis }}

runs:
  using: "composite"
  steps:
    ##############################################################################
      # EVALUATE METRICS AND STATUS AGAINST THRESHOLDS AND EXPORT AS OUTPUTS
    ##############################################################################

    - name: ðŸ§® EVALUATE METRICS AND STATUS AGAINST THRESHOLDS AND EXPORT AS OUTPUTS
      id: evaluate-metrics-status
      shell: pwsh
      env:
        SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        JOB_STATUS: ${{ inputs.JOB_STATUS }}   # ðŸ‘ˆ capture job status here
        SKIP_FLAG: ${{ inputs.SKIP_FLAG }}
        SONAR_PROJECT_KEY: ${{ env.SONAR_PROJECT_KEY }}
        SONAR_ORG: ${{ env.SONAR_ORG }}
        BRANCH_EXECUTED: ${{ inputs.BRANCH_EXECUTED }}
        REPOSITORY: ${{ github.repository }}
      run: |
        pwsh -File .\.github\scripts\evaluate-metrics-status.ps1

      ###################################
      # EXECUTION INFO COMPOSITE CALL
      ###################################
    - name: Call Execution Info
      id: execution-info
      uses: ./.github/actions/execution-info
      with:
        startTime: ${{ inputs.startTime }}
        SKIP_FLAG: ${{ inputs.SKIP_FLAG }}
        COMMIT_MSG: ${{ inputs.COMMIT_MSG }}
        COMMIT_AUTHOR: ${{ inputs.COMMIT_AUTHOR }}
        TRIGGER_EVENT: ${{ inputs.TRIGGER_EVENT }}
        SRC_BRANCH: ${{ inputs.SRC_BRANCH }}
        TGT_BRANCH: ${{ inputs.TGT_BRANCH }}
        BRANCH_EXECUTED: ${{ inputs.BRANCH_EXECUTED }}


    #    - name: Log Start/End Time After Execution Info
    #      run: |
    #        Write-Host "âœ… Start Time after execution-info: ${{ steps.execution-info.outputs.startTime }}"
    #        Write-Host "âœ… End Time after execution-info:   ${{ steps.execution-info.outputs.endTime }}"
    #        Write-Host "âœ… Duration after execution-info:   ${{ steps.execution-info.outputs.formattedDuration }}"
    #        Write-Host "âœ… ARTIFACT_URL:   ${{ inputs.ARTIFACT_URL }}"
    #      shell: pwsh

    - name: Publish GITHUB SUMMARY
      id: publish-hygiene-summary
      uses: ./.github/actions/publish-hygiene-summary
      with:
        BRANCH_EXECUTED: ${{ inputs.BRANCH_EXECUTED }}
        COMMIT_MSG: ${{ inputs.COMMIT_MSG }}
        COMMIT_AUTHOR: ${{ inputs.COMMIT_AUTHOR }}
        ARTIFACT_URL: ${{ inputs.ARTIFACT_URL }}
        STAGE_VS_MAIN_STATE: ${{ inputs.STAGE_VS_MAIN_STATE }}

        sonarCoverage: ${{ steps.evaluate-metrics-status.outputs.sonarCoverage }}
        coverageStatus: ${{ steps.evaluate-metrics-status.outputs.coverageStatus }}
        coverageBar: ${{ steps.evaluate-metrics-status.outputs.coverageBar }}
        checkstyleCount: ${{ steps.evaluate-metrics-status.outputs.checkstyleCount }}
        checkstyleStatus: ${{ steps.evaluate-metrics-status.outputs.checkstyleStatus }}
        pmdCount: ${{ steps.evaluate-metrics-status.outputs.pmdCount }}
        pmdStatus: ${{ steps.evaluate-metrics-status.outputs.pmdStatus }}
        totalSonarFetchedIssues: ${{ steps.evaluate-metrics-status.outputs.totalSonarFetchedIssues }}
        sonarExecutionNote: ${{ steps.evaluate-metrics-status.outputs.sonarExecutionNote }}
        sonarIssuesNote: ${{ steps.evaluate-metrics-status.outputs.sonarIssuesNote }}
        lastSonarAnalysis: ${{ steps.evaluate-metrics-status.outputs.lastSonarAnalysis }}
        sonarBlocker: ${{ steps.evaluate-metrics-status.outputs.sonarBlocker }}
        sonarBlockerUrl: ${{ steps.evaluate-metrics-status.outputs.sonarBlockerUrl }}
        sonarBlockerEmojiMark: ${{ steps.evaluate-metrics-status.outputs.sonarBlockerEmojiMark }}
        sonarHigh: ${{ steps.evaluate-metrics-status.outputs.sonarHigh }}
        sonarHighUrl: ${{ steps.evaluate-metrics-status.outputs.sonarHighUrl }}
        sonarHighEmojiMark: ${{ steps.evaluate-metrics-status.outputs.sonarHighEmojiMark }}
        sonarMedium: ${{ steps.evaluate-metrics-status.outputs.sonarMedium }}
        sonarMediumUrl: ${{ steps.evaluate-metrics-status.outputs.sonarMediumUrl }}
        sonarMediumEmojiMark: ${{ steps.evaluate-metrics-status.outputs.sonarMediumEmojiMark }}
        sonarLow: ${{ steps.evaluate-metrics-status.outputs.sonarLow }}
        sonarLowUrl: ${{ steps.evaluate-metrics-status.outputs.sonarLowUrl }}
        sonarLowEmojiMark: ${{ steps.evaluate-metrics-status.outputs.sonarLowEmojiMark }}
        sonarInfo: ${{ steps.evaluate-metrics-status.outputs.sonarInfo }}
        sonarInfoUrl: ${{ steps.evaluate-metrics-status.outputs.sonarInfoUrl }}
        sonarInfoEmojiMark: ${{ steps.evaluate-metrics-status.outputs.sonarInfoEmojiMark }}
        statusLegend: ${{ steps.evaluate-metrics-status.outputs.statusLegend }}
        sonarOpenIssuesDashboardURL: ${{ steps.evaluate-metrics-status.outputs.sonarOpenIssuesDashboardURL }}
        sonarOverallCodeDashBoardURL: ${{ steps.evaluate-metrics-status.outputs.sonarOverallCodeDashBoardURL }}

        moduleAgg: ${{ steps.evaluate-metrics-status.outputs.moduleAgg }}
        EMAIL_BREAKDOWN: ${{ steps.evaluate-metrics-status.outputs.EMAIL_BREAKDOWN }}
        EMAIL_MODULE_SEV_AGG_TABLE: ${{ steps.evaluate-metrics-status.outputs.EMAIL_MODULE_SEV_AGG_TABLE }}

        #Only goes to github publish summary
        GITHUB_SUMMARY_MODULE_SEV_AGG_TABLE:  ${{ steps.evaluate-metrics-status.outputs.GITHUB_SUMMARY_MODULE_SEV_AGG_TABLE }}

        HygieneCheckStatus: ${{ steps.evaluate-metrics-status.outputs.HygieneCheckStatus }}
        NextStepsHtml: ${{ steps.evaluate-metrics-status.outputs.NextStepsHtml }}

        FULL_SHA: ${{ steps.execution-info.outputs.FULL_SHA }}
        SHORT_SHA: ${{ steps.execution-info.outputs.SHORT_SHA }}
        TRIGGER_INFO: ${{ steps.execution-info.outputs.TRIGGER_INFO }}
        COMMIT_DATE: ${{ steps.execution-info.outputs.COMMIT_DATE }}
        startTime: ${{ steps.execution-info.outputs.startTime }}
        START_EPOCH: ${{ inputs.startTime }}
        endTime: ${{ steps.execution-info.outputs.endTime }}
        formattedDuration: ${{ steps.execution-info.outputs.formattedDuration }}
