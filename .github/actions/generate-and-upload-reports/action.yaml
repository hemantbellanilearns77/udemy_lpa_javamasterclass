##############################################################
# PERFORM HYGIENE HEALTH CHECKS AND UPLOAD REPORTS
##############################################################
name: "Perform Hygiene Health Checks and Upload Reports"
description: ""
inputs:
  SKIP_FLAG:
    description: ""
    required: true

outputs:
  ARTIFACT_URL:
    description: ""
    value: ${{ steps.artifact_url.outputs.ARTIFACT_URL }}
runs:
  using: "composite"
  steps:
    #####################################
    # RUN ALL-HYGIENE SWEEP CHECK
    #####################################
    - name: ALL-HYGIENE SWEEP CHECK (Run hygiene health check analysis via batch script)
      if: success()
      shell: pwsh
      run: |
        $SKIP_FLAG = "${{ inputs.SKIP_FLAG }}"
        # --- DEBUG: show what is being passed
        Write-Host "üß™ SKIP_FLAG received in composite: '$SKIP_FLAG'"
          if ([string]::IsNullOrWhiteSpace($SKIP_FLAG)) {
          Write-Host "‚ö†Ô∏è SKIP_FLAG is empty ‚Äî defaulting to 'Hello There'"
          $SKIP_FLAG = "Hello There"
        }
        Write-Host "üß™ SKIP_FLAG as finally being passed to batch script in composite: '$SKIP_FLAG'"
        # Write-Host the environment variable directly to ensure its value is printed.
        Write-Host "üß™ Bash path from previous step: '$env:SONAR_SCANNER_BIN'"
        & scripts/hygiene-check-analysis.bat githubactions $SKIP_FLAG

    ##########################
    # UPLOAD REPORTS
    ##########################

    - name: ?? Upload All Reports
      id: upload_reports
      uses: actions/upload-artifact@v4
      with:
        name: hygiene-check-artifacts-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          logs/**
          reports/**
        compression-level: 9 # Set to '9' for best compression
          

    - name: Set Artifact Download URL
      id: artifact_url
      shell: pwsh
      run: |
        $artifactId = "${{ steps.upload_reports.outputs.artifact-id }}"
        $repo = "${{ github.repository }}"
        $runId = "${{ github.run_id }}"
        $artifactUrl = "https://github.com/$repo/actions/runs/$runId/artifacts/$artifactId"
        Write-Host "üß™ ARTIFACT_URL as finally being passed downstream: '$artifactUrl'"
        "ARTIFACT_URL=$artifactUrl" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
