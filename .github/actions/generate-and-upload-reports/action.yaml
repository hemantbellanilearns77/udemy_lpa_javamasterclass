##############################################################
# PERFORM HYGIENE HEALTH CHECKS AND UPLOAD REPORTS
##############################################################
name: "Perform Hygiene Health Checks and Upload Reports"
description: ""
inputs:
  SKIP_FLAG:
    description: ""
    required: true
  scanner_bin_dir:
    description: ""
    required: true

outputs:
  ARTIFACT_URL:
    description: ""
    value: ${{ steps.artifact_url.outputs.ARTIFACT_URL }}
runs:
  using: "composite"
  steps:
    #####################################
    # RUN ALL-HYGIENE SWEEP CHECK
    #####################################
    - name: ALL-HYGIENE SWEEP CHECK (Run hygiene health check analysis via batch script)
      if: success()
      shell: pwsh
      env: # Define the environment variable at the step level
        SONAR_SCANNER_BIN_WIN: ${{ format('{0}', inputs.scanner_bin_dir) }}
      run: |
        $SKIP_FLAG = "${{ inputs.SKIP_FLAG }}"

        # --- DEBUG: show what is being passed
        Write-Host "üß™ SKIP_FLAG received in composite: '$SKIP_FLAG'"
          if ([string]::IsNullOrWhiteSpace($SKIP_FLAG)) {
          Write-Host "‚ö†Ô∏è SKIP_FLAG is empty ‚Äî defaulting to ''"
          $SKIP_FLAG = ""
        }
        Write-Host "üß™ SKIP_FLAG as finally being passed to batch script in composite: '$SKIP_FLAG'"
        
        $scanner_bin_dir = "${{ inputs.scanner_bin_dir }}"
        Write-Host "üß™ scanner_bin_dir received in composite: '$scanner_bin_dir'"
        # Convert the Bash-style path from the previous step's output to a Windows-style path
        # The 'cmd.exe /c "cygpath -w ..."' command is used to run cygpath, a utility found on Windows GitHub runners
        $scannerBinPathWindows = (cmd.exe /c "cygpath -w `"$env:SONAR_SCANNER_BIN_WIN`"").Trim()
        
        Write-Host "Bash path from previous step: '$env:SONAR_SCANNER_BIN_WIN'"
        Write-Host "Converted Windows path for batch script: '$scannerBinPathWindows'"

        # Set the environment variable for the batch script using the Windows path
        "SONAR_SCANNER_BIN=$scannerBinPathWindows" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf-8 -Append
        & scripts/hygiene-check-analysis.bat githubactions $SKIP_FLAG

    ##########################
    # UPLOAD REPORTS
    ##########################

    - name: ?? Upload All Reports
      id: upload_reports
      uses: actions/upload-artifact@v4
      with:
        name: hygiene-reports
        path: |
          reports/**
          logs/**

    - name: Set Artifact Download URL
      id: artifact_url
      shell: pwsh
      run: |
        $artifactId = "${{ steps.upload_reports.outputs.artifact-id }}"
        $repo = "${{ github.repository }}"
        $runId = "${{ github.run_id }}"
        $artifactUrl = "https://github.com/$repo/actions/runs/$runId/artifacts/$artifactId"
        Write-Host "üß™ ARTIFACT_URL as finally being passed downstream: '$artifactUrl'"
        "ARTIFACT_URL=$artifactUrl" | Out-File -FilePath $env:GITHUB_OUTPUT -Append