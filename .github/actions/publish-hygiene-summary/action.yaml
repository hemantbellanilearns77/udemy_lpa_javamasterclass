##############################################################
# GITHUB  SUMMARY COMPOSITE
##############################################################
name: "Publish GitHub Summary Composite"
description: "Reusable step to send hygiene summary email"
inputs:
  HygieneCheckStatus:
    required: true
    description: ""
  NextStepsHtml:
    required: true
    description: ""
  BRANCH_EXECUTED:
    required: true
    description: ""
  sonarCoverage:
    required: true
    description: ""
  coverageBar:
    required: true
    description: ""
  checkstyleCount:
    required: true
    description: ""
  checkstyleStatus:
    required: true
    description: ""
  pmdCount:
    required: true
    description: ""
  pmdStatus:
    required: true
    description: ""
  sonarExecutionNote:
    required: true
    description: ""
  sonarIssuesNote:
    required: true
    description: ""
  lastSonarAnalysis:
    required: true
    description: ""
  sonarBlocker:
    required: true
    description: ""
  sonarBlockerUrl:
    required: true
    description: ""
  sonarBlockerEmojiMark:
    required: true
    description: ""
  sonarHigh:
    required: true
    description: ""
  sonarHighUrl:
    required: true
    description: ""
  sonarHighEmojiMark:
    required: true
    description: ""
  sonarMedium:
    required: true
    description: ""
  sonarMediumUrl:
    required: true
    description: ""
  sonarMediumEmojiMark:
    required: true
    description: ""
  sonarLow:
    required: true
    description: ""
  sonarLowUrl:
    required: true
    description: ""
  sonarLowEmojiMark:
    required: true
    description: ""
  sonarInfo:
    required: true
    description: ""
  sonarInfoUrl:
    required: true
    description: ""
  sonarInfoEmojiMark:
    required: true
    description: ""
  statusLegend:
    required: true
    description: ""
  sonarOpenIssuesDashboardURL:
    required: true
    description: ""
  sonarOverallCodeDashBoardURL:
    required: true
    description: ""
  EMAIL_MODULE_SEV_AGG_TABLE:
    required: true
    description: ""
  FULL_SHA:
    required: true
    description: ""
  SHORT_SHA:
    required: true
    description: ""
  TRIGGER_INFO:
    required: true
    description: ""
  COMMIT_MSG:
    required: true
    description: ""
  COMMIT_AUTHOR:
    required: true
    description: ""
  COMMIT_DATE:
    required: true
    description: ""
  startTime:
    required: true
    description: ""
  START_EPOCH:
    required: true
    description: ""
  endTime:
    required: true
    description: ""
  formattedDuration:
    required: true
    description: ""
  ARTIFACT_URL:
    required: true
    description: ""
  STAGE_VS_MAIN_STATE:
    required: true
    description: ""
  GITHUB_SUMMARY_MODULE_SEV_AGG_TABLE:
    required: true
    description: ""

runs:
  using: "composite"
  steps:
    ####################################################
    # Publish GITHUB SUMMARY
    #      $branch                = "${{ inputs.BRANCH_EXECUTED }}"
    #      $repository            = "${{ github.repository }}"
    #      $checkstyleViolations  = "${{ inputs.checkstyleCount }}"
    #      $pmdViolations         = "${{ inputs.pmdCount }}"
    #      $sonarCoverage         = "${{ inputs.sonarCoverage }}"
    #      $coverageStatus        = "${{ inputs.coverageStatus }}"
    #      $coverageBar           = "${{ inputs.coverageBar }}"
    #      $sonarExecutionNote    = "${{ inputs.sonarExecutionNote }}"
    #      $sonarIssuesNote       = "${{ inputs.sonarIssuesNote }}"
    #      $lastSonarAnalysis     = "${{ inputs.lastSonarAnalysis }}"
    #      $sonarBlocker          = "${{ inputs.sonarBlocker }}"
    #      $sonarBlockerUrl       = "${{ inputs.sonarBlockerUrl }}"
    #      $sonarBlockerEmojiMark = "${{ inputs.sonarBlockerEmojiMark }}"
    #      $sonarHigh             = "${{ inputs.sonarHigh }}"
    #      $sonarHighUrl          = "${{ inputs.sonarHighUrl }}"
    #      $sonarHighEmojiMark    = "${{ inputs.sonarHighEmojiMark }}"
    #      $sonarMedium           = "${{ inputs.sonarMedium }}"
    #      $sonarMediumUrl        = "${{ inputs.sonarMediumUrl }}"
    #      $sonarMediumEmojiMark  = "${{ inputs.sonarMediumEmojiMark }}"
    #      $sonarLow              = "${{ inputs.sonarLow }}"
    #      $sonarLowUrl           = "${{ inputs.sonarLowUrl }}"
    #      $sonarLowEmojiMark     = "${{ inputs.sonarLowEmojiMark }}"
    #      $sonarInfo             = "${{ inputs.sonarInfo }}"
    #      $sonarInfoUrl          = "${{ inputs.sonarInfoUrl }}"
    #      $sonarInfoEmojiMark    = "${{ inputs.sonarInfoEmojiMark }}"
    #      $sonarOverallUrl       = "${{ inputs.sonarOverallCodeDashBoardURL }}"
    #      $sonarOpenIssuesUrl    = "${{ inputs.sonarOpenIssuesDashboardURL }}"
    #      $moduleTableHtml       = "${{ inputs.GITHUB_SUMMARY_MODULE_SEV_AGG_TABLE }}"
    #      $sonarLegend           = "${{ inputs.sonarIssuesLegend }}"
    #      $stageState            = "${{ inputs.STAGE_VS_MAIN_STATE }}"
    ####################################################
    - name: Publish GITHUB Summary
      id: publish-github-summary
      shell: pwsh
      run: |
        $branch = "${{ inputs.BRANCH_EXECUTED }}"
        $repository = "${{ github.repository }}"
        $checkstyleViolations = "${{ inputs.checkstyleCount }}"
        $pmdViolations = "${{ inputs.pmdCount }}"
        $sonarCoverage = "${{ inputs.sonarCoverage }}"
        $coverageStatus = "${{ inputs.coverageStatus }}"
        $coverageBar="${{ inputs.coverageBar }}"
        $lastCommitURL="https://github.com/${{ github.repository }}/commit/${{ inputs.FULL_SHA }}"
        
         ############################################################
                   # === Write Overall Table ===
         ############################################################
         echo "### ğŸ“Š Hygiene Summary (Checkstyle + PMD + JaCoCo + Sonar)" >> $env:GITHUB_STEP_SUMMARY
         echo "Repository: $repository " >> $env:GITHUB_STEP_SUMMARY
         echo "Branch: $branch" >> $env:GITHUB_STEP_SUMMARY
         echo "Stage â†” Main state: ${{inputs.STAGE_VS_MAIN_STATE }}" >> $env:GITHUB_STEP_SUMMARY
         echo "| **Metric**               | **Value** |" >> $env:GITHUB_STEP_SUMMARY
         echo "|------------------------- |-----------|" >> $env:GITHUB_STEP_SUMMARY
         echo "| ğŸ“ˆ Code Coverage (Sonar)    | $sonarCoverage $coverageStatus |" >> $env:GITHUB_STEP_SUMMARY
         echo "| ğŸ¯ Coverage Visual          | <code>$coverageBar</code> |" >> $env:GITHUB_STEP_SUMMARY
         echo "| ğŸ“ Checkstyle Violations    | $checkstyleViolations ${{ inputs.checkstyleStatus }} |" >> $env:GITHUB_STEP_SUMMARY
         echo "| ğŸ” PMD Violations           | $pmdViolations ${{ inputs.pmdStatus }} |" >> $env:GITHUB_STEP_SUMMARY
         echo "| ğŸ—‚ SonarCloud                | Execution: <code>${{inputs.sonarExecutionNote}}</code><br/>Issues: <code>${{inputs.sonarIssuesNote}}</code><br/>Last Analysis: <code>${{inputs.lastSonarAnalysis }}</code> |" >> $env:GITHUB_STEP_SUMMARY
         echo "| ğŸŸ¥ BLOCKER                   | [${{ inputs.sonarBlocker }}](${{ inputs.sonarBlockerUrl }}) ${{ inputs.sonarBlockerEmojiMark }} |" >> $env:GITHUB_STEP_SUMMARY
         echo "| ğŸŸ§ HIGH                      | [${{ inputs.sonarHigh }}](${{ inputs.sonarHighUrl }}) ${{ inputs.sonarHighEmojiMark }} |" >> $env:GITHUB_STEP_SUMMARY
         echo "| ğŸŸ¨ MEDIUM                    | [${{ inputs.sonarMedium }}](${{ inputs.sonarMediumUrl }}) ${{ inputs.sonarMediumEmojiMark }} |" >> $env:GITHUB_STEP_SUMMARY
         echo "| ğŸŸ¦ LOW                       | [${{ inputs.sonarLow }}](${{ inputs.sonarLowUrl }}) ${{ inputs.sonarLowEmojiMark }} |" >> $env:GITHUB_STEP_SUMMARY
         echo "| â„¹ INFO                      | [${{ inputs.sonarInfo }}](${{ inputs.sonarInfoUrl }}) ${{ inputs.sonarInfoEmojiMark }} |" >> $env:GITHUB_STEP_SUMMARY
         echo "| Legend                       | ${{ inputs.statusLegend }} |" >> $env:GITHUB_STEP_SUMMARY
         echo "| ğŸ”— Key Links | - ğŸŒ [SonarCloud â€“ Overall Code Dashboard](${{ inputs.sonarOverallCodeDashBoardUrl }}) <br/> - ğŸŒ [SonarCloud â€“ Issues Breakdown Dashboard](${{ inputs.sonarOpenIssuesDashboardUrl }}) <br/> - ğŸŒ [Last Commit Here:]($lastCommitURL) |" >> $env:GITHUB_STEP_SUMMARY
  
         echo "${{ inputs.GITHUB_SUMMARY_MODULE_SEV_AGG_TABLE }}" >> $env:GITHUB_STEP_SUMMARY


    ####################################################
          # CALCULATE EXECUTION TIMINGS
    ####################################################
    - name: Compute Execution (Commit + Trigger + Duration) Info
      id: execution_timings
      shell: pwsh
      env:
        START_EPOCH: ${{ inputs.START_EPOCH }}
      run: |
        # Define IST offset
        $istOffset = [System.TimeSpan]::FromHours(5.5)
        
        $startEpoch = [int]$env:START_EPOCH
        $endEpoch = [int][double]::Parse((Get-Date -UFormat %s))
        
        $startDT = [System.DateTimeOffset]::FromUnixTimeSeconds($startEpoch).ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
        $endDT = [System.DateTimeOffset]::FromUnixTimeSeconds($endEpoch).ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
        
        # Convert to DateTimeOffset and shift to IST
        $startDT_IST = [System.DateTimeOffset]::FromUnixTimeSeconds($startEpoch).ToOffset($istOffset).ToString("yyyy-MM-dd HH:mm:ss")
        $endDT_IST   = [System.DateTimeOffset]::FromUnixTimeSeconds($endEpoch).ToOffset($istOffset).ToString("yyyy-MM-dd HH:mm:ss")
        
        $durationSec = $endEpoch - $startEpoch
        $mins = [math]::Floor($durationSec / 60)
        $secs = $durationSec % 60
        $durationFormatted = "{0}m {1}s" -f $mins, $secs
        
        echo "startTime=$startDT_IST" >> $env:GITHUB_OUTPUT
        echo "endTime=$endDT_IST" >> $env:GITHUB_OUTPUT
        echo "formattedDuration=$durationFormatted" >> $env:GITHUB_OUTPUT
        #       Write-Host "âœ… START DATE-TIME (UTC)| $startDT"
        #       Write-Host "âœ… END DATE-TIME (UTC) | $endDT"
        #       Write-Host "âœ… START DATE-TIME (IST) | $startDT_IST"
        #       Write-Host "âœ… END DATE-TIME (IST) | $endDT_IST"
        #       Write-Host "âœ… FORMATTED DURATION | $durationFormatted"

    ##########################
    # Email Success Summary
    ##########################
    - name: ğŸ“§ Send Hygiene Summary Email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ env.SMTP_SERVER_ADDRESS }}
        server_port: ${{ env.SMTP_SERVER_PORT }}
        username: ${{ env.SMTP_USER }}
        password: ${{ env.SMTP_PASS }}
#        subject: >-
#          ${{ inputs.HygieneCheckStatus }} | ${{ github.workflow }} | ${{ github.repository }} | Branch: ${{ inputs.BRANCH_EXECUTED }} | Run #${{ github.run_id }} | Duration: ${{ steps.execution_timings.outputs.formattedDuration }} | Coverage Status: ${{ inputs.sonarCoverage }} ${{ inputs.coverageStatus }}
        subject: >-
           ${{ inputs.HygieneCheckStatus }} | ${{ github.workflow }} | Run #${{ github.run_number }} | Repository: ${{ github.repository }} | Branch: ${{ inputs.BRANCH_EXECUTED }} | Duration: ${{ steps.execution_timings.outputs.formattedDuration }}
        to: ${{ env.EMAIL_RECIPIENT }}
        from: GitHub Hygiene Bot <${{ env.EMAIL_RECIPIENT }}>

        html_body: |
          <html>
          <body style="margin:0; padding:0;">
            <table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%">
              <tr>
                <td style="padding:16px;">
                  <table role="presentation" border="0" cellpadding="0" cellspacing="0" width="100%"
                  style="max-width:600px; margin:0 auto; background:#ffffff;">
                    <tr>
                      <td style="padding:16px; font-family:Calibri, sans-serif; font-size:12pt; color:#2b2b2b; line-height:1.8;">
                        <!-- all your existing HTML content goes here -->
                        <p style="margin-bottom:16px;">Dear Hemant,</p>
                        <h2 style="color:#1a5276; border-bottom:1px solid #dcdcdc; padding-bottom:4px;">
                          ğŸ Hygiene Check : 
                          <span style="color:${{ inputs.HygieneCheckStatus == 'PASSED âœ…' && 'green' || 'red' }};">
                            <code style="font-family:Calibri, sans-serif; font-size:12pt;">${{ inputs.HygieneCheckStatus }}</code>
                          </span>
                        </h2>
                        <p style="margin:0 0 12px 0;">
                            <strong>Repository:</strong> <code>${{ github.repository }}</code><br/>
                            <strong>Branch:</strong> <code>${{ inputs.BRANCH_EXECUTED }}</code><br/>
                            <strong>Stage â†” Main state:</strong> <code>${{ inputs.STAGE_VS_MAIN_STATE }}</code><br/>
                            <strong>Run:</strong>
                            <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" style="color:#1a5276; text-decoration:none;">#${{ github.run_number }}</a>
                            <br/>
                            <strong>Job Execution Status:</strong>
                            <span style="color:${{ job.status == 'success' && 'green' || 'red' }};">
                            <code style="font-family:Calibri, sans-serif; font-size:12pt; font-weight:bold;">
                            ${{ job.status }}
                            </code>
                            </span><br/>
                            <strong>Duration:</strong>
                            <code>${{ steps.execution_timings.outputs.formattedDuration }}</code>
                          </p>

                        <p style="margin:12px 0; font-style:italic; color:#5d6d7e;">
                           ${{ inputs.statusLegend }}
                        </p>
                        
                        <h3 style="color:#117864; margin-top:24px; border-bottom:1px solid #e6e6e6; padding-bottom:3px;">ğŸ“Š Summary</h3>
                        <ul style="margin:6px 0 12px 18px; padding:0;">
                          <li style="margin-bottom:6px;"><b>ğŸ“ˆ Code Coverage:</b> 
                            ${{ inputs.sonarCoverage }} ${{ inputs.coverageStatus }}
                          </li>
                          <li style="margin-bottom:6px;">ğŸ¯ <b>Coverage Visual:</b> <code>${{ inputs.coverageBar }}</code></li>
                          <li style="margin-bottom:6px;">ğŸ“ <b>Checkstyle Violations:</b> <code>${{ inputs.checkstyleCount }}</code> ${{ inputs.checkstyleStatus }}</li>
                          <li style="margin-bottom:6px;">ğŸ” <b>PMD Violations:</b> <code>${{ inputs.pmdCount }}</code>${{ inputs.pmdStatus }}</li>
                          <li style="margin-bottom:6px;">ğŸ—‚ <b>SonarCloud:</b>
                            <ul style="margin:6px 0 12px 18px; padding:0;">
                              <li style="margin-bottom:6px;">Execution: <code>${{ inputs.sonarExecutionNote }}</code></li>
                              <li style="margin-bottom:6px;">Issues: <code>${{ inputs.sonarIssuesNote }}</code></li>
                              <li style="margin-bottom:6px;">Last Analysis: <code>${{ inputs.lastSonarAnalysis }}</code></li>
                            </ul>
                            <b>ğŸ›  SonarCloud Impact Severity Breakdown:</b>
                            <ul style="margin:6px 0 12px 18px; padding:0;">
                              <li style="margin-bottom:6px;">ğŸŸ¥ BLOCKER: <a href="${{ inputs.sonarBlockerUrl }}" style="color:#1a5276; text-decoration:none;"><code>${{ inputs.sonarBlocker }}</code></a> ${{ inputs.sonarBlockerEmojiMark }}</li>
                              <li style="margin-bottom:6px;">ğŸŸ§ HIGH: <a href="${{ inputs.sonarHighUrl }}" style="color:#1a5276; text-decoration:none;"><code>${{ inputs.sonarHigh }}</code></a> ${{ inputs.sonarHighEmojiMark }}</li>
                              <li style="margin-bottom:6px;">ğŸŸ¨ MEDIUM: <a href="${{ inputs.sonarMediumUrl }}" style="color:#1a5276; text-decoration:none;"><code>${{ inputs.sonarMedium }}</code></a> ${{ inputs.sonarMediumEmojiMark }}</li>
                              <li style="margin-bottom:6px;">ğŸŸ¦ LOW: <a href="${{ inputs.sonarLowUrl }}" style="color:#1a5276; text-decoration:none;"><code>${{ inputs.sonarLow }}</code></a> ${{ inputs.sonarLowEmojiMark }}</li>
                              <li style="margin-bottom:6px;">â„¹ï¸ INFO: <a href="${{ inputs.sonarInfoUrl }}" style="color:#1a5276; text-decoration:none;"><code>${{ inputs.sonarInfo }}</code></a> ${{ inputs.sonarInfoEmojiMark }}</li>
                            </ul>
                          </li>
                        </ul>

                        <h3 style="color:#117864; margin-top:24px; border-bottom:1px solid #e6e6e6; padding-bottom:3px;">ğŸ“¦ Module-Wise Impact-Severity</h3>
                        <div style="margin:8px 0 16px 0;">
                          ${{ inputs.EMAIL_MODULE_SEV_AGG_TABLE }}
                        </div>

                        <h3 style="color:#117864; margin-top:24px; border-bottom:1px solid #e6e6e6; padding-bottom:3px;">ğŸ”— Key Links</h3>
                        <ul style="margin:6px 0 12px 18px; padding:0;">
                          <li style="margin-bottom:6px;"><a href="${{ inputs.sonarOverallCodeDashBoardURL }}" style="color:#1a5276; text-decoration:none;">SonarCloud â€“ ${{ inputs.BRANCH_EXECUTED }} Branch Summary</a></li>
                          <li style="margin-bottom:6px;"><a href="${{ inputs.sonarOpenIssuesDashboardURL }}" style="color:#1a5276; text-decoration:none;">SonarCloud Open Issues - Impact Severity Breakdown</a></li>
                          <li style="margin-bottom:6px;"><a href="https://github.com/${{ github.repository }}/commit/${{ inputs.FULL_SHA }}" style="color:#1a5276; text-decoration:none;">View Last Commit (SHA=${{ inputs.SHORT_SHA }})</a></li>
                          <li style="margin-bottom:6px;"><a href="${{ inputs.ARTIFACT_URL }}" style="color:#1a5276; text-decoration:none;">Download Hygiene Reports (Run: ${{ github.run_id }})</a></li>
                          <li style="margin-bottom:6px;"><b>Run Details:</b><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" style="color:#1a5276; text-decoration:none;">#${{ github.run_number }}</a></li>
                          <li style="margin-bottom:6px;"><a href="https://github.com/${{ github.repository }}/actions" style="color:#1a5276; text-decoration:none;">GitHub Actions Dashboard</a></li>                        </ul>

                        <h3 style="color:#117864; margin-top:24px; border-bottom:1px solid #e6e6e6; padding-bottom:3px;">ğŸ“Œ Next Steps</h3>
                        <ul style="margin:6px 0 12px 18px; padding:0;">
                          ${{ inputs.NextStepsHtml }}
                        </ul>
                        <h3 style="color:#117864; margin-top:24px; border-bottom:1px solid #e6e6e6; padding-bottom:3px;">ğŸ“œ Job Execution Details
                        
                        </h3>
                        <ul style="margin:6px 0 12px 18px; padding:0;">
                          <li style="margin-bottom:6px;">Job Execution Status: 
                            <span style="color:${{ job.status == 'success' && 'green' || 'red' }};">
                            <code style="font-family:Calibri, sans-serif; font-size:12pt; font-weight:bold;">
                              ${{ job.status }}
                             </code>
                             </span>
                          </li>
                          <li style="margin-bottom:6px;">Triggered by: <code>${{ inputs.TRIGGER_INFO }}</code></li>
                          <li style="margin-bottom:6px;">Author of Last Commit / Approver of Last PR: <code>${{ inputs.COMMIT_AUTHOR }}</code></li>
                          <li style="margin-bottom:6px;">Last Commit Message / PR Approval & Merge Message: <code>${{ inputs.COMMIT_MSG }}</code></li>
                          <li style="margin-bottom:6px;">Last Commit / PR Approval & Merge, Date: <code>${{ inputs.COMMIT_DATE }} (IST)</code></li>
                          <li style="margin-bottom:6px;">Job Duration: <code>${{ steps.execution_timings.outputs.formattedDuration }}</code></li>
                          <li style="margin-bottom:6px;">Start: <code>${{ steps.execution_timings.outputs.startTime }}</code> | End: <code>${{ steps.execution_timings.outputs.endTime }}</code></li>
                         
                        </ul>
                        <p style="margin-top:20px; color:#5d6d7e; font-style:italic;">
                          ğŸ•’ All times reported in IST.<br/>
                          ğŸ¤– This is an automated notification from GitHub Actions. For any queries, please check the linked dashboards.
                        </p>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </body>
          </html>
